{"version":3,"file":"node-build.mjs","sources":["../../server/routes/demo.ts","../../server/routes/vehicles.ts","../../server/routes/orders.ts","../../server/middleware/auth.ts","../../server/routes/auth.ts","../../server/routes/users.ts","../../server/routes/moderation.ts","../../server/routes/announcements.ts","../../server/index.ts","../../server/node-build.ts"],"sourcesContent":["import { RequestHandler } from \"express\";\nimport { DemoResponse } from \"@shared/api\";\n\nexport const handleDemo: RequestHandler = (req, res) => {\n  const response: DemoResponse = {\n    message: \"Hello from Express server\",\n  };\n  res.status(200).json(response);\n};\n","import { Request, Response } from \"express\";\nimport { neon } from \"@netlify/neon\";\n\nconst sql = neon(process.env.NETLIFY_DATABASE_URL!);\n\nexport async function getAllVehicles(req: Request, res: Response) {\n  try {\n    const { search, category } = req.query;\n\n    let query = `SELECT * FROM vehicles`;\n    const conditions: string[] = [];\n    const params: any[] = [];\n    let paramIndex = 1;\n\n    if (search && typeof search === 'string') {\n      conditions.push(`name ILIKE $${paramIndex}`);\n      params.push(`%${search}%`);\n      paramIndex++;\n    }\n\n    if (category && typeof category === 'string' && category !== 'all') {\n      conditions.push(`category = $${paramIndex}`);\n      params.push(category);\n      paramIndex++;\n    }\n\n    if (conditions.length > 0) {\n      query += ` WHERE ${conditions.join(' AND ')}`;\n    }\n\n    query += ` ORDER BY category, name`;\n\n    const vehicles = params.length > 0 \n      ? await sql(query, params)\n      : await sql(query);\n\n    res.json(vehicles);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration des v√©hicules :\", error);\n    res.status(500).json({ error: \"‚ö†Ô∏è Impossible de charger le catalogue. Veuillez r√©essayer\" });\n  }\n}\n\nexport async function getVehicleById(req: Request, res: Response) {\n  try {\n    const { id } = req.params;\n    const [vehicle] = await sql`SELECT * FROM vehicles WHERE id = ${id}`;\n    \n    if (!vehicle) {\n      return res.status(404).json({ error: \"‚ùå V√©hicule introuvable\" });\n    }\n\n    res.json(vehicle);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration du v√©hicule :\", error);\n    res.status(500).json({ error: \"‚ö†Ô∏è Impossible de charger les d√©tails du v√©hicule\" });\n  }\n}\n\nexport async function createVehicle(req: Request, res: Response) {\n  try {\n    const { name, category, price, trunk_weight, image_url, seats, particularity } = req.body;\n\n    if (!name || !category || !price || trunk_weight === undefined || !image_url || seats === undefined) {\n      return res.status(400).json({ error: \"‚ö†Ô∏è Tous les champs du v√©hicule sont obligatoires (nom, cat√©gorie, prix, capacit√© coffre, image, places)\" });\n    }\n\n    const [vehicle] = await sql`\n      INSERT INTO vehicles (name, category, price, trunk_weight, image_url, seats, particularity)\n      VALUES (${name}, ${category}, ${price}, ${trunk_weight}, ${image_url}, ${seats}, ${particularity || null})\n      RETURNING *\n    `;\n\n    res.status(201).json(vehicle);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la cr√©ation du v√©hicule :\", error);\n    res.status(500).json({ error: \"‚ùå Impossible de cr√©er le v√©hicule. Veuillez v√©rifier que toutes les informations sont valides et r√©essayer\" });\n  }\n}\n\nexport async function updateVehicle(req: Request, res: Response) {\n  try {\n    const { id } = req.params;\n    const { name, category, price, trunk_weight, image_url, seats, particularity } = req.body;\n\n    if (!name || !category || !price || trunk_weight === undefined || !image_url || seats === undefined) {\n      return res.status(400).json({ error: \"‚ö†Ô∏è Tous les champs du v√©hicule sont obligatoires (nom, cat√©gorie, prix, capacit√© coffre, image, places)\" });\n    }\n\n    const [vehicle] = await sql`\n      UPDATE vehicles\n      SET name = ${name},\n          category = ${category},\n          price = ${price},\n          trunk_weight = ${trunk_weight},\n          image_url = ${image_url},\n          seats = ${seats},\n          particularity = ${particularity || null},\n          updated_at = CURRENT_TIMESTAMP\n      WHERE id = ${id}\n      RETURNING *\n    `;\n\n    if (!vehicle) {\n      return res.status(404).json({ error: \"‚ùå V√©hicule non trouv√©. V√©rifiez que l'ID du v√©hicule existe\" });\n    }\n\n    res.json(vehicle);\n  } catch (error) {\n    console.error(\"Error updating vehicle:\", error);\n    res.status(500).json({ error: \"‚ùå Impossible de mettre √† jour le v√©hicule. Veuillez v√©rifier les donn√©es et r√©essayer\" });\n  }\n}\n\nexport async function deleteVehicle(req: Request, res: Response) {\n  try {\n    const { id } = req.params;\n\n    const [vehicle] = await sql`\n      DELETE FROM vehicles WHERE id = ${id} RETURNING *\n    `;\n\n    if (!vehicle) {\n      return res.status(404).json({ error: \"‚ùå V√©hicule non trouv√©. V√©rifiez que l'ID du v√©hicule existe\" });\n    }\n\n    res.json({ message: \"‚úÖ V√©hicule supprim√© avec succ√®s\", vehicle });\n  } catch (error) {\n    console.error(\"Error deleting vehicle:\", error);\n    res.status(500).json({ error: \"‚ùå Impossible de supprimer le v√©hicule. Veuillez r√©essayer plus tard\" });\n  }\n}\n\nexport async function getCategories(req: Request, res: Response) {\n  try {\n    const categories = await sql`\n      SELECT DISTINCT category FROM vehicles ORDER BY category\n    `;\n\n    res.json(categories.map(c => c.category));\n  } catch (error) {\n    console.error(\"Error fetching categories:\", error);\n    res.status(500).json({ error: \"‚ö†Ô∏è Impossible de charger les cat√©gories. Veuillez r√©essayer\" });\n  }\n}\n","import { Request, Response } from \"express\";\nimport { neon } from \"@netlify/neon\";\nimport { randomUUID } from \"crypto\";\n\nconst sql = neon(process.env.NETLIFY_DATABASE_URL!);\n\nexport async function initOrdersTables() {\n  try {\n    await sql`\n      CREATE TABLE IF NOT EXISTS announcements (\n        id SERIAL PRIMARY KEY,\n        content TEXT,\n        is_active BOOLEAN DEFAULT false,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `;\n\n    await sql`\n      CREATE TABLE IF NOT EXISTS orders (\n        id SERIAL PRIMARY KEY,\n        unique_id VARCHAR(36) NOT NULL,\n        first_name VARCHAR(100) NOT NULL,\n        last_name VARCHAR(100) NOT NULL,\n        phone VARCHAR(20) NOT NULL,\n        status VARCHAR(20) DEFAULT 'pending',\n        total_price INTEGER NOT NULL,\n        validated_by VARCHAR(100),\n        validated_at TIMESTAMP,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `;\n\n    await sql`\n      CREATE TABLE IF NOT EXISTS order_items (\n        id SERIAL PRIMARY KEY,\n        order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,\n        vehicle_id INTEGER NOT NULL,\n        vehicle_name VARCHAR(255) NOT NULL,\n        vehicle_category VARCHAR(100) NOT NULL,\n        vehicle_price INTEGER NOT NULL,\n        vehicle_image_url TEXT,\n        quantity INTEGER NOT NULL DEFAULT 1,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `;\n\n    await sql`\n      CREATE TABLE IF NOT EXISTS banned_unique_ids (\n        id SERIAL PRIMARY KEY,\n        unique_id VARCHAR(36) UNIQUE NOT NULL,\n        reason VARCHAR(255),\n        banned_by VARCHAR(100),\n        banned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `;\n\n    // Add missing columns if they don't exist\n    try {\n      await sql`ALTER TABLE orders ADD COLUMN unique_id VARCHAR(36) UNIQUE`;\n    } catch {\n      // Column already exists\n    }\n\n    try {\n      await sql`ALTER TABLE orders ADD COLUMN validated_by VARCHAR(100)`;\n    } catch {\n      // Column already exists\n    }\n\n    try {\n      await sql`ALTER TABLE orders ADD COLUMN validated_at TIMESTAMP`;\n    } catch {\n      // Column already exists\n    }\n\n    try {\n      await sql`ALTER TABLE orders ADD COLUMN client_ip VARCHAR(45)`;\n    } catch {\n      // Column already exists\n    }\n\n    try {\n      await sql`ALTER TABLE orders ADD COLUMN cancellation_reason TEXT`;\n    } catch {\n      // Column already exists\n    }\n\n    // Try to remove UNIQUE constraint on unique_id if it exists (allow multiple orders per ID)\n    try {\n      await sql`ALTER TABLE orders DROP CONSTRAINT IF EXISTS orders_unique_id_key`;\n      console.log(\"Dropped UNIQUE constraint on unique_id\");\n    } catch (error) {\n      // Constraint might not exist, continue silently\n    }\n\n    await sql`CREATE INDEX IF NOT EXISTS idx_orders_status ON orders (status)`;\n    await sql`CREATE INDEX IF NOT EXISTS idx_orders_unique_id ON orders (unique_id)`;\n    await sql`CREATE INDEX IF NOT EXISTS idx_order_items_order_id ON order_items (order_id)`;\n    await sql`CREATE INDEX IF NOT EXISTS idx_banned_unique_ids ON banned_unique_ids (unique_id)`;\n    \n    console.log(\"Orders tables initialized successfully\");\n  } catch (error) {\n    console.error(\"Error initializing orders tables:\", error);\n  }\n}\n\ninitOrdersTables();\n\nexport async function createOrder(req: Request, res: Response) {\n  try {\n    const { firstName, lastName, phone, items, totalPrice, uniqueId } = req.body;\n\n    // Get client IP address\n    const clientIp = (req.headers['x-forwarded-for'] as string)?.split(',')[0].trim() || \n                     req.socket?.remoteAddress || \n                     'unknown';\n\n    if (!firstName || !lastName || !phone || !items || items.length === 0 || !uniqueId) {\n      return res.status(400).json({ error: \"Tous les champs sont requis\" });\n    }\n\n    const nameRegex = /^[a-zA-Z√Ä-√ø\\s'-]+$/;\n    if (!nameRegex.test(firstName) || !nameRegex.test(lastName)) {\n      return res.status(400).json({ error: \"Le nom et pr√©nom ne doivent contenir que des lettres\" });\n    }\n\n    // Clean phone: remove all non-digit characters\n    const cleanPhone = phone.replace(/\\D/g, '');\n    const phoneRegex = /^\\d{8,}$/;\n    if (!phoneRegex.test(cleanPhone)) {\n      return res.status(400).json({ error: \"Num√©ro de t√©l√©phone invalide\" });\n    }\n\n    // Validate unique ID - only numbers allowed\n    const uniqueIdRegex = /^\\d+$/;\n    if (!uniqueIdRegex.test(uniqueId.trim())) {\n      return res.status(400).json({ error: \"‚ö†Ô∏è L'ID unique ne doit contenir que des chiffres\" });\n    }\n\n    // Check if unique ID is banned\n    const bannedIdCheck = await sql`\n      SELECT id FROM banned_unique_ids WHERE unique_id = ${uniqueId.trim()} LIMIT 1\n    `;\n\n    if (bannedIdCheck && bannedIdCheck.length > 0) {\n      return res.status(403).json({ error: \"‚ùå Commande refus√©e - Votre acc√®s aux commandes a √©t√© bloqu√©. Veuillez contacter le support\" });\n    }\n\n    // Check if unique ID already has a pending order\n    const pendingOrderCheck = await sql`\n      SELECT id FROM orders WHERE unique_id = ${uniqueId.trim()} AND status = 'pending' LIMIT 1\n    `;\n\n    if (pendingOrderCheck && pendingOrderCheck.length > 0) {\n      return res.status(409).json({ error: \"‚ùå Cet ID unique a d√©j√† une commande en attente. Veuillez attendre la livraison ou l'annulation de la commande pr√©c√©dente\" });\n    }\n\n    const [order] = await sql`\n      INSERT INTO orders (unique_id, first_name, last_name, phone, total_price, status, client_ip)\n      VALUES (${uniqueId.trim()}, ${firstName}, ${lastName}, ${cleanPhone}, ${totalPrice}, 'pending', ${clientIp})\n      RETURNING *\n    `;\n\n    for (const item of items) {\n      await sql`\n        INSERT INTO order_items (order_id, vehicle_id, vehicle_name, vehicle_category, vehicle_price, vehicle_image_url, quantity)\n        VALUES (${order.id}, ${item.vehicleId}, ${item.vehicleName}, ${item.vehicleCategory}, ${item.vehiclePrice}, ${item.vehicleImageUrl}, ${item.quantity})\n      `;\n    }\n\n    const orderItems = await sql`\n      SELECT * FROM order_items WHERE order_id = ${order.id}\n    `;\n\n    // Send webhooks for order creation\n    const webhookUrl = process.env.WEBHOOK_URL;\n    const discordWebhookUrl = process.env.DISCORD_WEBHOOK_URL;\n\n    if (webhookUrl) {\n      try {\n        const payload = {\n          type: \"new_order\",\n          title: \"üéâ NOUVELLE COMMANDE RE√áUE üéâ\",\n          order: {\n            uniqueId: order.unique_id,\n            id: order.id,\n            firstName: order.first_name,\n            lastName: order.last_name,\n            phone: order.phone,\n            totalPrice: order.total_price,\n            status: order.status,\n            createdAt: order.created_at,\n            items: orderItems.map((item: any) => ({\n              vehicleName: item.vehicle_name,\n              vehicleCategory: item.vehicle_category,\n              vehiclePrice: item.vehicle_price,\n              quantity: item.quantity,\n            })),\n          },\n        };\n        await fetch(webhookUrl, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(payload),\n        });\n        console.log(\"Webhook sent successfully for order\", order.id);\n      } catch (webhookError) {\n        console.error(\"‚ùå √âchec de l'envoi du webhook :\", webhookError);\n      }\n    }\n\n    if (discordWebhookUrl) {\n      try {\n        const itemsDetails = orderItems\n          .map((item: any) => ({\n            name: item.vehicle_name,\n            category: item.vehicle_category,\n            price: item.vehicle_price,\n            quantity: item.quantity,\n            subtotal: item.vehicle_price * item.quantity\n          }))\n          .reduce((acc, item) => {\n            return acc + `‚Ä¢ **${item.name}**\\n  üìÅ Cat√©gorie: ${item.category}\\n  üî¢ Quantit√©: ${item.quantity}x\\n  üíµ Prix unitaire: ${item.price.toLocaleString()}$\\n  ‚úÖ Sous-total: **${item.subtotal.toLocaleString()}$**\\n\\n`;\n          }, \"\");\n\n        const formattedPhone = phone.replace(/\\s+/g, \" \");\n        const formattedDate = new Date().toLocaleDateString(\"fr-FR\", {\n          weekday: \"long\",\n          year: \"numeric\",\n          month: \"long\",\n          day: \"numeric\",\n          hour: \"2-digit\",\n          minute: \"2-digit\"\n        });\n\n        await fetch(discordWebhookUrl, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            content: \"üéâ **NOUVELLE COMMANDE RE√áUE** üéâ\",\n            embeds: [\n              {\n                title: `üì¶ Commande #${order.id}`,\n                description: `Une nouvelle r√©servation a √©t√© enregistr√©e avec succ√®s!`,\n                color: 16766976,\n                fields: [\n                  {\n                    name: \"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ INFORMATIONS CLIENT ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\",\n                    value: \" \",\n                    inline: false,\n                  },\n                  {\n                    name: \"üë§ Nom complet\",\n                    value: `${firstName} ${lastName}`,\n                    inline: false,\n                  },\n                  {\n                    name: \"üìû T√©l√©phone\",\n                    value: `\\`${formattedPhone}\\``,\n                    inline: false,\n                  },\n                  {\n                    name: \"üîë ID Unique\",\n                    value: `\\`${order.unique_id}\\``,\n                    inline: false,\n                  },\n                  {\n                    name: \"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ V√âHICULES COMMAND√âS ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\",\n                    value: \" \",\n                    inline: false,\n                  },\n                  {\n                    name: `üöó ${items.length} V√©hicule${items.length > 1 ? \"s\" : \"\"}`,\n                    value: itemsDetails || \"Aucun\",\n                    inline: false,\n                  },\n                  {\n                    name: \"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ R√âCAPITULATIF ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\",\n                    value: \" \",\n                    inline: false,\n                  },\n                  {\n                    name: \"üí∞ Total √† payer\",\n                    value: `# **${totalPrice.toLocaleString()}$**`,\n                    inline: false,\n                  },\n                  {\n                    name: \"üìÖ Date\",\n                    value: formattedDate,\n                    inline: false,\n                  },\n                ],\n                footer: {\n                  text: \"Elite Vinewood Auto - Syst√®me de Gestion des Commandes\",\n                  icon_url: \"https://emoji.discord.com/emoji/1234567890\"\n                },\n                timestamp: new Date().toISOString(),\n              },\n            ],\n          }),\n        });\n      } catch (discordError) {\n        console.error(\"‚ùå √âchec de l'envoi du webhook Discord :\", discordError);\n      }\n    }\n\n    res.status(201).json({\n      ...order,\n      items: orderItems,\n    });\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la cr√©ation de la commande :\", error);\n    res.status(500).json({ error: \"‚ùå Impossible de cr√©er la commande. Veuillez v√©rifier vos informations et r√©essayer\" });\n  }\n}\n\nexport async function getAllOrders(req: Request, res: Response) {\n  try {\n    const { status } = req.query;\n\n    let orders;\n    if (status && typeof status === \"string\" && status !== \"all\") {\n      orders = await sql`\n        SELECT * FROM orders WHERE status = ${status} ORDER BY created_at DESC\n      `;\n    } else {\n      orders = await sql`SELECT * FROM orders ORDER BY created_at DESC`;\n    }\n\n    const ordersWithItems = await Promise.all(\n      orders.map(async (order: any) => {\n        const items = await sql`\n          SELECT * FROM order_items WHERE order_id = ${order.id}\n        `;\n        return {\n          ...order,\n          items,\n        };\n      })\n    );\n\n    res.json(ordersWithItems);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration des commandes :\", error);\n    res.status(500).json({ error: \"Erreur lors de la r√©cup√©ration des commandes\" });\n  }\n}\n\nexport async function getOrderById(req: Request, res: Response) {\n  try {\n    const { id } = req.params;\n\n    const [order] = await sql`SELECT * FROM orders WHERE id = ${id}`;\n    if (!order) {\n      return res.status(404).json({ error: \"Commande non trouv√©e\" });\n    }\n\n    const items = await sql`SELECT * FROM order_items WHERE order_id = ${id}`;\n\n    res.json({\n      ...order,\n      items,\n    });\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration de la commande :\", error);\n    res.status(500).json({ error: \"Erreur lors de la r√©cup√©ration de la commande\" });\n  }\n}\n\nexport async function updateOrderStatus(req: Request, res: Response) {\n  try {\n    const { id } = req.params;\n    const { status, username, cancellationReason } = req.body;\n\n    if (!status || ![\"pending\", \"delivered\", \"cancelled\"].includes(status)) {\n      return res.status(400).json({ error: \"‚ö†Ô∏è Le statut fourni est invalide. Veuillez choisir: en attente, livr√©e ou annul√©e\" });\n    }\n\n    let order;\n    if (status === \"delivered\" && username) {\n      [order] = await sql`\n        UPDATE orders\n        SET status = ${status}, validated_by = ${username}, validated_at = CURRENT_TIMESTAMP, updated_at = CURRENT_TIMESTAMP\n        WHERE id = ${id}\n        RETURNING *\n      `;\n    } else if (status === \"cancelled\" && cancellationReason) {\n      [order] = await sql`\n        UPDATE orders\n        SET status = ${status}, cancellation_reason = ${cancellationReason}, validated_by = ${username}, validated_at = CURRENT_TIMESTAMP, updated_at = CURRENT_TIMESTAMP\n        WHERE id = ${id}\n        RETURNING *\n      `;\n    } else {\n      [order] = await sql`\n        UPDATE orders\n        SET status = ${status}, updated_at = CURRENT_TIMESTAMP\n        WHERE id = ${id}\n        RETURNING *\n      `;\n    }\n\n    if (!order) {\n      return res.status(404).json({ error: \"‚ùå Commande introuvable - Cette commande n'existe pas ou a √©t√© supprim√©e\" });\n    }\n\n    // Fetch order items for webhook payload\n    const orderItems = await sql`\n      SELECT * FROM order_items WHERE order_id = ${order.id}\n    `;\n\n    // Send webhooks for status changes (delivered or cancelled)\n    const webhookUrl = process.env.WEBHOOK_URL;\n    const discordWebhookUrl = process.env.DISCORD_WEBHOOK_URL;\n\n    if (webhookUrl) {\n      try {\n        const formattedDate = new Date().toLocaleDateString(\"fr-FR\", {\n          weekday: \"long\",\n          year: \"numeric\",\n          month: \"long\",\n          day: \"numeric\",\n          hour: \"2-digit\",\n          minute: \"2-digit\"\n        });\n\n        // Map cancellation reason codes to French text\n        const cancellationReasonMap: { [key: string]: string } = {\n          \"customer_cancelled\": \"Commande annul√©e par le client\",\n          \"delivery_issue\": \"Souci de livraison\",\n          \"inappropriate_behavior\": \"Comportement du client inappropri√©\",\n        };\n\n        const statusLabel = status === \"delivered\" ? \"Commande livr√©e\" : \"Commande annul√©e\";\n        const statusEmoji = status === \"delivered\" ? \"‚úÖ\" : \"‚ùå\";\n\n        const orderData: any = {\n          uniqueId: order.unique_id,\n          id: order.id,\n          firstName: order.first_name,\n          lastName: order.last_name,\n          phone: order.phone,\n          totalPrice: order.total_price,\n          status: status,\n          createdAt: order.created_at,\n          validatedBy: `${username || \"Syst√®me\"} (${formattedDate})`,\n          items: orderItems.map((item: any) => ({\n            vehicleName: item.vehicle_name,\n            vehicleCategory: item.vehicle_category,\n            vehiclePrice: item.vehicle_price,\n            quantity: item.quantity,\n          })),\n        };\n\n        if (status === \"cancelled\" && (order as any).cancellation_reason) {\n          const reason = (order as any).cancellation_reason;\n          orderData.cancellationReason = cancellationReasonMap[reason] || reason;\n        }\n\n        const payload = {\n          type: status === \"delivered\" ? \"order_delivered\" : \"order_cancelled\",\n          title: `${statusEmoji} ${statusLabel} ${statusEmoji}`,\n          order: orderData,\n        };\n\n        await fetch(webhookUrl, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(payload),\n        });\n        console.log(`Webhook sent for order ${order.id} - Status: ${status}`);\n      } catch (webhookError) {\n        console.error(\"‚ùå √âchec de l'envoi du webhook de statut :\", webhookError);\n      }\n    }\n\n    if (discordWebhookUrl) {\n      try {\n        const itemsDetails = orderItems\n          .map((item: any) => ({\n            name: item.vehicle_name,\n            category: item.vehicle_category,\n            price: item.vehicle_price,\n            quantity: item.quantity,\n            subtotal: item.vehicle_price * item.quantity\n          }))\n          .reduce((acc: string, item: any) => {\n            return acc + `‚Ä¢ **${item.name}**\\n  üìÅ Cat√©gorie: ${item.category}\\n  üî¢ Quantit√©: ${item.quantity}x\\n  üíµ Prix unitaire: ${item.price.toLocaleString()}$\\n  ‚úÖ Sous-total: **${item.subtotal.toLocaleString()}$**\\n\\n`;\n          }, \"\");\n\n        const statusEmoji = status === \"delivered\" ? \"‚úÖ\" : \"‚ùå\";\n        const statusText = status === \"delivered\" ? \"COMMANDE LIVR√âE\" : \"COMMANDE ANNUL√âE\";\n        const embedColor = status === \"delivered\" ? 65280 : 16711680; // Green or Red\n\n        const formattedDateTime = new Date().toLocaleDateString(\"fr-FR\", {\n          weekday: \"long\",\n          year: \"numeric\",\n          month: \"long\",\n          day: \"numeric\",\n          hour: \"2-digit\",\n          minute: \"2-digit\"\n        });\n\n        let discordPayload: any = {\n          content: `${statusEmoji} **${statusText}** ${statusEmoji}`,\n          embeds: [\n            {\n              title: `üì¶ Commande #${order.id}`,\n              description: status === \"delivered\" ? \"La commande a √©t√© livr√©e avec succ√®s!\" : \"La commande a √©t√© annul√©e\",\n              color: embedColor,\n              fields: [\n                {\n                  name: \"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ INFORMATIONS CLIENT ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\",\n                  value: \" \",\n                  inline: false,\n                },\n                {\n                  name: \"üë§ Nom complet\",\n                  value: `${order.first_name} ${order.last_name}`,\n                  inline: false,\n                },\n                {\n                  name: \"üìû T√©l√©phone\",\n                  value: `\\`${order.phone}\\``,\n                  inline: false,\n                },\n                {\n                  name: \"üîë ID Unique\",\n                  value: `\\`${order.unique_id}\\``,\n                  inline: false,\n                },\n                {\n                  name: \"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ V√âHICULES ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\",\n                  value: \" \",\n                  inline: false,\n                },\n                {\n                  name: \"üöó D√©tails\",\n                  value: itemsDetails || \"Aucun\",\n                  inline: false,\n                },\n                {\n                  name: \"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ R√âCAPITULATIF ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\",\n                  value: \" \",\n                  inline: false,\n                },\n                {\n                  name: \"üí∞ Total\",\n                  value: `**${order.total_price.toLocaleString()}$**`,\n                  inline: false,\n                },\n                {\n                  name: \"üìÖ Trait√© par\",\n                  value: `${username || \"Syst√®me\"} le ${formattedDateTime}`,\n                  inline: false,\n                },\n              ],\n              footer: {\n                text: \"Elite Vinewood Auto - Syst√®me de Gestion des Commandes\",\n                icon_url: \"https://emoji.discord.com/emoji/1234567890\"\n              },\n              timestamp: new Date().toISOString(),\n            },\n          ],\n        };\n\n        if (status === \"cancelled\" && (order as any).cancellation_reason) {\n          const cancellationReasonMap: { [key: string]: string } = {\n            \"customer_cancelled\": \"Commande annul√©e par le client\",\n            \"delivery_issue\": \"Souci de livraison\",\n            \"inappropriate_behavior\": \"Comportement du client inappropri√©\",\n          };\n          const reason = (order as any).cancellation_reason;\n          const displayReason = cancellationReasonMap[reason] || reason;\n          discordPayload.embeds[0].fields.push({\n            name: \"üìù Raison\",\n            value: displayReason,\n            inline: false,\n          });\n        }\n\n        await fetch(discordWebhookUrl, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(discordPayload),\n        });\n        console.log(`Discord webhook sent for order ${order.id} - Status: ${status}`);\n      } catch (discordError) {\n        console.error(\"‚ùå √âchec de l'envoi du webhook Discord :\", discordError);\n      }\n    }\n\n    res.json(order);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la mise √† jour du statut de la commande :\", error);\n    res.status(500).json({ error: \"‚ö†Ô∏è Impossible de mettre √† jour le statut de la commande. Veuillez r√©essayer plus tard\" });\n  }\n}\n\nexport async function deleteOrder(req: Request, res: Response) {\n  try {\n    const { id } = req.params;\n\n    const [order] = await sql`\n      DELETE FROM orders WHERE id = ${id} RETURNING *\n    `;\n\n    if (!order) {\n      return res.status(404).json({ error: \"‚ùå Commande introuvable - Impossible de supprimer une commande inexistante\" });\n    }\n\n    res.json({ message: \"‚úÖ Commande supprim√©e avec succ√®s\" });\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la suppression d'une commande :\", error);\n    res.status(500).json({ error: \"‚ö†Ô∏è Impossible de supprimer la commande. Veuillez r√©essayer\" });\n  }\n}\n","import { Request, Response, NextFunction } from \"express\";\nimport jwt from \"jsonwebtoken\";\nimport { neon } from \"@netlify/neon\";\nimport type { JWTPayload } from \"../routes/auth\";\nimport type { UserPermissions } from \"../routes/users\";\n\nconst JWT_SECRET = process.env.JWT_SECRET;\nconst sql = neon(process.env.NETLIFY_DATABASE_URL!);\n\nif (!JWT_SECRET) {\n  throw new Error(\"JWT_SECRET environment variable is required for authentication\");\n}\n\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: JWTPayload;\n    }\n  }\n}\n\nexport async function adminAuth(req: Request, res: Response, next: NextFunction) {\n  const authHeader = req.headers.authorization;\n\n  if (!authHeader || !authHeader.startsWith(\"Bearer \")) {\n    return res.status(401).json({ error: \"‚ùå Authentification requise - Merci de vous connecter √† l'espace admin\" });\n  }\n\n  const token = authHeader.substring(7);\n\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET) as JWTPayload;\n\n    if (!decoded.authenticated) {\n      return res.status(403).json({ error: \"‚ùå Acc√®s refus√© - Vos identifiants sont invalides\" });\n    }\n\n    // Verify user still exists in database\n    // If user has been deleted, reject the token even if it's still valid\n    try {\n      const result = await sql`\n        SELECT id, permissions FROM admin_users WHERE id = ${decoded.userId} LIMIT 1\n      `;\n      \n      if (!result || result.length === 0) {\n        // User has been deleted - reject the token\n        return res.status(403).json({ error: \"‚ùå Acc√®s refus√© - Votre compte a √©t√© supprim√©. Veuillez contacter l'administrateur\" });\n      }\n      \n      // User exists, update permissions from database\n      decoded.permissions = result[0].permissions;\n    } catch (dbError) {\n      console.error(\"‚ùå Erreur lors de la v√©rification de l'utilisateur en DB :\", dbError);\n      // Continue with cached permissions if DB fails\n    }\n\n    req.user = decoded;\n    next();\n  } catch (error) {\n    return res.status(403).json({ error: \"‚ùå Session expir√©e - Merci de vous reconnecter\" });\n  }\n}\n\ntype PermissionCategory = keyof UserPermissions;\ntype VehiclePermission = keyof UserPermissions[\"vehicles\"];\ntype OrderPermission = keyof UserPermissions[\"orders\"];\ntype UserPermission = keyof UserPermissions[\"users\"];\n\nexport function requirePermission(category: PermissionCategory, permission: VehiclePermission | OrderPermission | UserPermission) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!req.user) {\n      return res.status(401).json({ error: \"‚ùå Authentification requise - Veuillez vous connecter\" });\n    }\n\n    const permissions = req.user.permissions;\n    \n    if (!permissions) {\n      return res.status(403).json({ error: \"‚ùå Acc√®s refus√© - Aucune permission assign√©e √† votre compte\" });\n    }\n\n    const categoryPermissions = permissions[category];\n    \n    if (!categoryPermissions || !(categoryPermissions as Record<string, boolean>)[permission]) {\n      const actionLabels: Record<string, string> = {\n        create: \"cr√©er\",\n        update: \"modifier\",\n        delete: \"supprimer\",\n        view: \"consulter\",\n        validate: \"valider\",\n        cancel: \"annuler\"\n      };\n      const categoryLabels: Record<string, string> = {\n        vehicles: \"les v√©hicules\",\n        orders: \"les commandes\",\n        users: \"les utilisateurs\"\n      };\n      const action = actionLabels[permission] || permission;\n      const categoryName = categoryLabels[category] || category;\n      return res.status(403).json({ \n        error: `üîí Permission refus√©e - Vous n'avez pas la permission de ${action} ${categoryName}. Contactez votre administrateur` \n      });\n    }\n\n    next();\n  };\n}\n\nexport function requireVehiclePermission(permission: VehiclePermission) {\n  return requirePermission(\"vehicles\", permission);\n}\n\nexport function requireOrderPermission(permission: OrderPermission) {\n  return requirePermission(\"orders\", permission);\n}\n\nexport function requireUserPermission(permission: UserPermission) {\n  return requirePermission(\"users\", permission);\n}\n","import type { Request, Response } from \"express\";\nimport jwt from \"jsonwebtoken\";\nimport { neon } from \"@netlify/neon\";\nimport type { UserPermissions } from \"./users\";\n\nconst JWT_SECRET = process.env.JWT_SECRET;\n\nif (!JWT_SECRET) {\n  throw new Error(\"JWT_SECRET environment variable is required for authentication\");\n}\n\nconst sql = neon(process.env.NETLIFY_DATABASE_URL!);\n\nexport interface JWTPayload {\n  userId: number;\n  username: string;\n  permissions: UserPermissions;\n  authenticated: boolean;\n}\n\nexport async function login(req: Request, res: Response) {\n  const { username, accessKey } = req.body;\n\n  if (!username || !accessKey) {\n    return res.status(400).json({ error: \"‚ö†Ô∏è Veuillez entrer un pseudonyme et une cl√© d'acc√®s\" });\n  }\n\n  try {\n    const result = await sql`\n      SELECT id, username, permissions\n      FROM admin_users\n      WHERE username = ${username} AND access_key = ${accessKey}\n      LIMIT 1\n    `;\n\n    if (!result || result.length === 0) {\n      return res.status(403).json({ error: \"‚ùå Pseudonyme ou cl√© d'acc√®s incorrect\" });\n    }\n\n    const user = result[0];\n\n    const token = jwt.sign(\n      {\n        userId: user.id,\n        username: user.username,\n        permissions: user.permissions,\n        authenticated: true,\n      } as JWTPayload,\n      JWT_SECRET,\n      { expiresIn: \"24h\" }\n    );\n\n    res.json({\n      token,\n      user: {\n        id: user.id,\n        username: user.username,\n        permissions: user.permissions,\n      },\n    });\n  } catch (error) {\n    console.error(\"‚ùå Erreur de connexion :\", error);\n    res.status(500).json({ error: \"‚ö†Ô∏è Une erreur s'est produite lors de la connexion. Veuillez r√©essayer\" });\n  }\n}\n\nexport async function getCurrentUser(req: Request, res: Response) {\n  const authHeader = req.headers.authorization;\n\n  if (!authHeader || !authHeader.startsWith(\"Bearer \")) {\n    return res.status(401).json({ error: \"‚ùå Authentification requise\" });\n  }\n\n  const token = authHeader.substring(7);\n\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET) as JWTPayload;\n\n    const result = await sql`\n      SELECT id, username, permissions\n      FROM admin_users\n      WHERE id = ${decoded.userId}\n      LIMIT 1\n    `;\n\n    if (!result || result.length === 0) {\n      return res.status(404).json({ error: \"‚ùå Profil utilisateur introuvable\" });\n    }\n\n    const user = result[0];\n\n    // Check if user has any permissions left at all\n    // If all permission categories are empty or false, user has been revoked access\n    const permissions = user.permissions || {};\n    const hasAnyPermission = Object.values(permissions).some((category: any) => {\n      if (typeof category === 'object') {\n        return Object.values(category).some((perm: any) => perm === true);\n      }\n      return category === true;\n    });\n\n    if (!hasAnyPermission) {\n      return res.status(403).json({ error: \"‚ùå Votre acc√®s a √©t√© r√©voqu√©. Vous n'avez plus de permissions\" });\n    }\n\n    res.json(user);\n  } catch (error) {\n    return res.status(403).json({ error: \"‚ùå Session expir√©e ou invalide\" });\n  }\n}\n","import type { Request, Response } from \"express\";\nimport { neon } from \"@netlify/neon\";\n\nconst sql = neon(process.env.NETLIFY_DATABASE_URL!);\n\nexport interface UserPermissions {\n  vehicles: {\n    view: boolean;\n    create: boolean;\n    update: boolean;\n    delete: boolean;\n  };\n  orders: {\n    view: boolean;\n    validate: boolean;\n    cancel: boolean;\n    delete: boolean;\n  };\n  users: {\n    view: boolean;\n    create: boolean;\n    update: boolean;\n    delete: boolean;\n  };\n  moderation: {\n    view: boolean;\n    ban_uniqueids: boolean;\n  };\n  announcements: {\n    view: boolean;\n    create: boolean;\n    update: boolean;\n    delete: boolean;\n  };\n}\n\nexport interface AdminUser {\n  id: number;\n  username: string;\n  access_key: string;\n  unique_id: string | null;\n  permissions: UserPermissions;\n  created_at: string;\n  updated_at: string;\n}\n\nconst DEFAULT_PERMISSIONS: UserPermissions = {\n  vehicles: { view: true, create: false, update: false, delete: false },\n  orders: { view: true, validate: false, cancel: false, delete: false },\n  users: { view: false, create: false, update: false, delete: false },\n  moderation: { view: false, ban_uniqueids: false },\n  announcements: { view: false, create: false, update: false, delete: false },\n};\n\nconst FULL_PERMISSIONS: UserPermissions = {\n  vehicles: { view: true, create: true, update: true, delete: true },\n  orders: { view: true, validate: true, cancel: true, delete: true },\n  users: { view: true, create: true, update: true, delete: true },\n  moderation: { view: true, ban_uniqueids: true },\n  announcements: { view: true, create: true, update: true, delete: true },\n};\n\nexport async function initUsersTable() {\n  try {\n    await sql`\n      CREATE TABLE IF NOT EXISTS admin_users (\n        id SERIAL PRIMARY KEY,\n        username VARCHAR(100) UNIQUE NOT NULL,\n        access_key VARCHAR(255) NOT NULL,\n        unique_id VARCHAR UNIQUE,\n        permissions JSONB NOT NULL DEFAULT '{}',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `;\n\n    // Add unique_id column if it doesn't exist\n    const checkColumn = await sql`\n      SELECT column_name \n      FROM information_schema.columns \n      WHERE table_name = 'admin_users' AND column_name = 'unique_id'\n    `;\n    \n    if (checkColumn.length === 0) {\n      await sql`\n        ALTER TABLE admin_users \n        ADD COLUMN unique_id VARCHAR UNIQUE\n      `;\n    }\n\n    const existingUsers = await sql`SELECT id FROM admin_users LIMIT 1`;\n    \n    if (existingUsers.length === 0) {\n      await sql`\n        INSERT INTO admin_users (username, access_key, permissions)\n        VALUES ('AK', '3l1t3v1n3w00d2k25@!', ${JSON.stringify(FULL_PERMISSIONS)})\n      `;\n      console.log(\"Default admin user 'AK' created with full permissions\");\n    }\n\n    console.log(\"Admin users table initialized successfully\");\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de l'initialisation de la table admin_users :\", error);\n  }\n}\n\nexport async function getAllUsers(req: Request, res: Response) {\n  try {\n    const users = await sql`\n      SELECT id, username, access_key, unique_id, permissions, created_at, updated_at\n      FROM admin_users\n      ORDER BY username ASC\n    `;\n    res.json(users);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration des utilisateurs :\", error);\n    res.status(500).json({ error: \"‚ùå Impossible de charger la liste des utilisateurs. Veuillez r√©essayer\" });\n  }\n}\n\nexport async function getUserById(req: Request, res: Response) {\n  const { id } = req.params;\n\n  try {\n    const users = await sql`\n      SELECT id, username, access_key, unique_id, permissions, created_at, updated_at\n      FROM admin_users\n      WHERE id = ${parseInt(id)}\n    `;\n\n    if (users.length === 0) {\n      return res.status(404).json({ error: \"‚ùå Utilisateur non trouv√© - V√©rifiez que l'ID de l'utilisateur existe\" });\n    }\n\n    res.json(users[0]);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration d'un utilisateur :\", error);\n    res.status(500).json({ error: \"‚ùå Erreur lors du chargement de l'utilisateur\" });\n  }\n}\n\nexport async function createUser(req: Request, res: Response) {\n  const { username, access_key, unique_id, permissions } = req.body;\n\n  if (!username || !access_key) {\n    return res.status(400).json({ error: \"‚ö†Ô∏è Le pseudonyme et la cl√© d'acc√®s sont obligatoires\" });\n  }\n\n  if (unique_id && !/^\\d+$/.test(unique_id)) {\n    return res.status(400).json({ error: \"‚ö†Ô∏è L'ID unique ne doit contenir que des chiffres\" });\n  }\n\n  try {\n    const existingUser = await sql`\n      SELECT id FROM admin_users WHERE username = ${username}\n    `;\n\n    if (existingUser.length > 0) {\n      return res.status(409).json({ error: \"‚ùå Ce pseudonyme est d√©j√† utilis√©. Veuillez choisir un autre pseudonyme\" });\n    }\n\n    if (unique_id) {\n      const existingId = await sql`\n        SELECT id FROM admin_users WHERE unique_id = ${unique_id}\n      `;\n      if (existingId.length > 0) {\n        return res.status(409).json({ error: \"‚ùå Cet ID unique est d√©j√† utilis√©. Veuillez choisir un autre ID\" });\n      }\n    }\n\n    const userPermissions = permissions || DEFAULT_PERMISSIONS;\n\n    const result = await sql`\n      INSERT INTO admin_users (username, access_key, unique_id, permissions)\n      VALUES (${username}, ${access_key}, ${unique_id || null}, ${JSON.stringify(userPermissions)})\n      RETURNING id, username, access_key, unique_id, permissions, created_at, updated_at\n    `;\n\n    res.status(201).json(result[0]);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la cr√©ation d'un utilisateur :\", error);\n    res.status(500).json({ error: \"‚ùå Impossible de cr√©er l'utilisateur. V√©rifiez que le pseudonyme n'existe pas d√©j√† et que la cl√© d'acc√®s est valide\" });\n  }\n}\n\nexport async function updateUser(req: Request, res: Response) {\n  const { id } = req.params;\n  const { username, access_key, unique_id, permissions } = req.body;\n\n  try {\n    const existingUser = await sql`\n      SELECT id FROM admin_users WHERE id = ${parseInt(id)}\n    `;\n\n    if (existingUser.length === 0) {\n      return res.status(404).json({ error: \"‚ùå Utilisateur non trouv√© - V√©rifiez que l'ID de l'utilisateur existe\" });\n    }\n\n    if (unique_id && !/^\\d+$/.test(unique_id)) {\n      return res.status(400).json({ error: \"‚ö†Ô∏è L'ID unique ne doit contenir que des chiffres\" });\n    }\n\n    if (username) {\n      const duplicateUser = await sql`\n        SELECT id FROM admin_users WHERE username = ${username} AND id != ${parseInt(id)}\n      `;\n      if (duplicateUser.length > 0) {\n        return res.status(409).json({ error: \"‚ùå Ce pseudonyme est d√©j√† utilis√©. Veuillez choisir un autre pseudonyme\" });\n      }\n    }\n\n    if (unique_id !== undefined && unique_id !== null) {\n      const duplicateId = await sql`\n        SELECT id FROM admin_users WHERE unique_id = ${unique_id} AND id != ${parseInt(id)}\n      `;\n      if (duplicateId.length > 0) {\n        return res.status(409).json({ error: \"‚ùå Cet ID unique est d√©j√† utilis√©. Veuillez choisir un autre ID\" });\n      }\n    }\n\n    const setClauses = [];\n\n    if (username !== undefined) {\n      setClauses.push(`username = '${username}'`);\n    }\n    if (access_key !== undefined) {\n      setClauses.push(`access_key = '${access_key}'`);\n    }\n    if (unique_id !== undefined) {\n      setClauses.push(`unique_id = ${unique_id ? `'${unique_id}'` : 'NULL'}`);\n    }\n    if (permissions !== undefined) {\n      setClauses.push(`permissions = '${JSON.stringify(permissions)}'`);\n    }\n\n    if (setClauses.length === 0) {\n      return res.status(400).json({ error: \"‚ö†Ô∏è Veuillez modifier au moins un champ\" });\n    }\n\n    setClauses.push(`updated_at = CURRENT_TIMESTAMP`);\n\n    const result = await sql`\n      UPDATE admin_users\n      SET ${sql(setClauses.join(', '))}\n      WHERE id = ${parseInt(id)}\n      RETURNING id, username, access_key, unique_id, permissions, created_at, updated_at\n    `;\n\n    res.json(result[0]);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la mise √† jour d'un utilisateur :\", error);\n    res.status(500).json({ error: \"‚ùå Impossible de mettre √† jour l'utilisateur. V√©rifiez que les valeurs sont valides\" });\n  }\n}\n\nexport async function deleteUser(req: Request, res: Response) {\n  const { id } = req.params;\n\n  try {\n    const usersCount = await sql`SELECT COUNT(*) as count FROM admin_users`;\n    \n    if (parseInt(usersCount[0].count) <= 1) {\n      return res.status(400).json({ error: \"‚ùå Impossible de supprimer le dernier administrateur. Il doit rester au minimum un compte admin\" });\n    }\n\n    const result = await sql`\n      DELETE FROM admin_users\n      WHERE id = ${parseInt(id)}\n      RETURNING id\n    `;\n\n    if (result.length === 0) {\n      return res.status(404).json({ error: \"‚ùå Utilisateur non trouv√© - V√©rifiez que l'ID de l'utilisateur existe\" });\n    }\n\n    res.json({ message: \"‚úÖ Utilisateur supprim√© avec succ√®s\" });\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la suppression d'un utilisateur :\", error);\n    res.status(500).json({ error: \"‚ùå Erreur lors de la suppression de l'utilisateur\" });\n  }\n}\n","import { Request, Response } from \"express\";\nimport { neon } from \"@netlify/neon\";\n\nconst sql = neon(process.env.NETLIFY_DATABASE_URL!);\n\nexport async function getAllBannedIds(req: Request, res: Response) {\n  try {\n    const ids = await sql`\n      SELECT id, unique_id, reason, banned_by, banned_at FROM banned_unique_ids ORDER BY banned_at DESC\n    `;\n    res.json(ids);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration des IDs bannis :\", error);\n    res.status(500).json({ error: \"‚ö†Ô∏è Impossible de charger les IDs bannis\" });\n  }\n}\n\nexport async function banId(req: Request, res: Response) {\n  try {\n    const { uniqueId, reason } = req.body;\n    const bannedBy = req.user?.username || \"admin\";\n\n    if (!uniqueId) {\n      return res.status(400).json({ error: \"‚ö†Ô∏è ID unique requis\" });\n    }\n\n    // Validate unique ID - only numbers allowed\n    const uniqueIdRegex = /^\\d+$/;\n    if (!uniqueIdRegex.test(uniqueId.trim())) {\n      return res.status(400).json({ error: \"‚ö†Ô∏è L'ID unique ne doit contenir que des chiffres\" });\n    }\n\n    const [bannedId] = await sql`\n      INSERT INTO banned_unique_ids (unique_id, reason, banned_by)\n      VALUES (${uniqueId.trim()}, ${reason || null}, ${bannedBy})\n      ON CONFLICT (unique_id) DO UPDATE SET reason = EXCLUDED.reason, banned_by = EXCLUDED.banned_by, banned_at = CURRENT_TIMESTAMP\n      RETURNING *\n    `;\n\n    res.status(201).json(bannedId);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors du bannissement d'un ID :\", error);\n    res.status(500).json({ error: \"‚ö†Ô∏è Impossible de bannir l'ID unique\" });\n  }\n}\n\nexport async function unbanId(req: Request, res: Response) {\n  try {\n    const { uniqueId } = req.body;\n\n    if (!uniqueId) {\n      return res.status(400).json({ error: \"‚ö†Ô∏è ID unique requis\" });\n    }\n\n    // Validate unique ID - only numbers allowed\n    const uniqueIdRegex = /^\\d+$/;\n    if (!uniqueIdRegex.test(uniqueId.trim())) {\n      return res.status(400).json({ error: \"‚ö†Ô∏è L'ID unique ne doit contenir que des chiffres\" });\n    }\n\n    const [result] = await sql`\n      DELETE FROM banned_unique_ids WHERE unique_id = ${uniqueId.trim()} RETURNING *\n    `;\n\n    if (!result) {\n      return res.status(404).json({ error: \"‚ùå ID unique non trouv√© dans la liste des bannissements\" });\n    }\n\n    res.json({ message: \"‚úÖ ID unique d√©banni avec succ√®s\" });\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors du d√©bannissement d'un ID :\", error);\n    res.status(500).json({ error: \"‚ö†Ô∏è Impossible de d√©bannir l'ID unique\" });\n  }\n}\n","import type { Request, Response } from \"express\";\nimport { neon } from \"@netlify/neon\";\n\nconst sql = neon(process.env.NETLIFY_DATABASE_URL!);\n\nexport async function initAnnouncementsTable() {\n  try {\n    await sql`\n      CREATE TABLE IF NOT EXISTS announcements (\n        id SERIAL PRIMARY KEY,\n        content TEXT,\n        is_active BOOLEAN DEFAULT false,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `;\n    console.log(\"‚úÖ Announcements table initialized successfully\");\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de l'initialisation de la table announcements :\", error);\n  }\n}\n\nexport async function getAnnouncement(req: Request, res: Response) {\n  try {\n    const announcements = await sql`\n      SELECT id, content, is_active, created_at, updated_at\n      FROM announcements\n      WHERE is_active = true\n      ORDER BY created_at DESC\n      LIMIT 1\n    `;\n    res.json(announcements.length > 0 ? announcements[0] : null);\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la r√©cup√©ration de l'annonce :\", error);\n    res.status(500).json({ error: \"‚ùå Erreur lors du chargement de l'annonce\" });\n  }\n}\n\nexport async function updateAnnouncement(req: Request, res: Response) {\n  const { content, is_active } = req.body;\n\n  try {\n    await sql`\n      DELETE FROM announcements\n    `;\n\n    if (content && content.trim()) {\n      const result = await sql`\n        INSERT INTO announcements (content, is_active)\n        VALUES (${content.trim()}, ${is_active || false})\n        RETURNING id, content, is_active, created_at, updated_at\n      `;\n      res.json(result[0]);\n    } else {\n      res.json(null);\n    }\n  } catch (error) {\n    console.error(\"‚ùå Erreur lors de la mise √† jour de l'annonce :\", error);\n    res.status(500).json({ error: \"‚ùå Erreur lors de la mise √† jour de l'annonce\" });\n  }\n}\n","import \"dotenv/config\";\nimport express from \"express\";\nimport cors from \"cors\";\nimport { handleDemo } from \"./routes/demo\";\nimport {\n  getAllVehicles,\n  getVehicleById,\n  createVehicle,\n  updateVehicle,\n  deleteVehicle,\n  getCategories,\n} from \"./routes/vehicles\";\nimport {\n  createOrder,\n  getAllOrders,\n  getOrderById,\n  updateOrderStatus,\n  deleteOrder,\n  initOrdersTables,\n} from \"./routes/orders\";\nimport { adminAuth, requireUserPermission, requireVehiclePermission, requireOrderPermission } from \"./middleware/auth\";\nimport { login, getCurrentUser } from \"./routes/auth\";\nimport { getAllUsers, getUserById, createUser, updateUser, deleteUser, initUsersTable } from \"./routes/users\";\nimport { getAllBannedIds, banId, unbanId } from \"./routes/moderation\";\nimport { getAnnouncement, updateAnnouncement, initAnnouncementsTable } from \"./routes/announcements\";\n\nexport function createServer() {\n  const app = express();\n\n  // Middleware\n  app.use(cors());\n  app.use(express.json());\n  app.use(express.urlencoded({ extended: true }));\n\n  // Initialize database tables\n  initUsersTable();\n  initOrdersTables();\n  initAnnouncementsTable();\n\n  // Example API routes\n  app.get(\"/api/ping\", (_req, res) => {\n    const ping = process.env.PING_MESSAGE ?? \"ping\";\n    res.json({ message: ping });\n  });\n\n  app.get(\"/api/demo\", handleDemo);\n\n  // Auth routes\n  app.post(\"/api/auth/login\", login);\n  app.get(\"/api/auth/me\", adminAuth, getCurrentUser);\n\n  // User management routes - require user management permissions\n  app.get(\"/api/users\", adminAuth, requireUserPermission(\"view\"), getAllUsers);\n  app.get(\"/api/users/:id\", adminAuth, requireUserPermission(\"view\"), getUserById);\n  app.post(\"/api/users\", adminAuth, requireUserPermission(\"create\"), createUser);\n  app.put(\"/api/users/:id\", adminAuth, requireUserPermission(\"update\"), updateUser);\n  app.delete(\"/api/users/:id\", adminAuth, requireUserPermission(\"delete\"), deleteUser);\n\n  // Vehicle API routes - read operations are public, write operations require admin auth + permissions\n  app.get(\"/api/vehicles\", getAllVehicles);\n  app.get(\"/api/vehicles/categories\", getCategories);\n  app.get(\"/api/vehicles/:id\", getVehicleById);\n  app.post(\"/api/vehicles\", adminAuth, requireVehiclePermission(\"create\"), createVehicle);\n  app.put(\"/api/vehicles/:id\", adminAuth, requireVehiclePermission(\"update\"), updateVehicle);\n  app.delete(\"/api/vehicles/:id\", adminAuth, requireVehiclePermission(\"delete\"), deleteVehicle);\n\n  // Order API routes - create is public, management requires admin auth + permissions\n  app.post(\"/api/orders\", createOrder);\n  app.get(\"/api/orders\", adminAuth, getAllOrders);\n  app.get(\"/api/orders/:id\", adminAuth, getOrderById);\n  app.put(\"/api/orders/:id/status\", adminAuth, requireOrderPermission(\"validate\"), updateOrderStatus);\n  app.delete(\"/api/orders/:id\", adminAuth, requireOrderPermission(\"delete\"), deleteOrder);\n\n  // Moderation routes - ban unique ID management requires admin auth + moderation permissions\n  app.get(\"/api/moderation/banned-ids\", adminAuth, requireModerationPermission(\"ban_uniqueids\"), getAllBannedIds);\n  app.post(\"/api/moderation/ban-id\", adminAuth, requireModerationPermission(\"ban_uniqueids\"), banId);\n  app.delete(\"/api/moderation/ban-id\", adminAuth, requireModerationPermission(\"ban_uniqueids\"), unbanId);\n\n  // Announcements routes - public read, admin write\n  app.get(\"/api/announcements\", getAnnouncement);\n  app.put(\"/api/announcements\", adminAuth, requireUserPermission(\"view\"), updateAnnouncement);\n\n  return app;\n}\n\nfunction requireModerationPermission(permission: \"ban_uniqueids\") {\n  return (req: any, res: any, next: any) => {\n    if (!req.user) {\n      return res.status(401).json({ error: \"‚ùå Authentification requise - Veuillez vous connecter\" });\n    }\n\n    const permissions = req.user.permissions;\n    \n    if (!permissions) {\n      return res.status(403).json({ error: \"‚ùå Acc√®s refus√© - Aucune permission assign√©e √† votre compte\" });\n    }\n\n    if (!permissions.moderation || !permissions.moderation[permission]) {\n      return res.status(403).json({ \n        error: `üîí Permission refus√©e - Vous n'avez pas la permission de g√©rer les bannissements d'IP. Contactez votre administrateur` \n      });\n    }\n\n    next();\n  };\n}\n","import path from \"path\";\nimport { createServer } from \"./index\";\nimport * as express from \"express\";\n\nconst app = createServer();\nconst port = process.env.PORT || 5000;\n\n// In production, serve the built SPA files\nconst __dirname = import.meta.dirname;\nconst distPath = path.join(__dirname, \"../spa\");\n\n// Serve static files\napp.use(express.static(distPath));\n\n// Handle React Router - serve index.html for all non-API routes\napp.use((req, res, next) => {\n  // Don't serve index.html for API routes\n  if (req.path.startsWith(\"/api/\") || req.path.startsWith(\"/health\")) {\n    return res.status(404).json({ error: \"API endpoint not found\" });\n  }\n\n  res.sendFile(path.join(distPath, \"index.html\"));\n});\n\napp.listen(port, () => {\n  console.log(`üöÄ Fusion Starter server running on port ${port}`);\n  console.log(`üì± Frontend: http://localhost:${port}`);\n  console.log(`üîß API: http://localhost:${port}/api`);\n});\n\n// Graceful shutdown\nprocess.on(\"SIGTERM\", () => {\n  console.log(\"üõë Received SIGTERM, shutting down gracefully\");\n  process.exit(0);\n});\n\nprocess.on(\"SIGINT\", () => {\n  console.log(\"üõë Received SIGINT, shutting down gracefully\");\n  process.exit(0);\n});\n"],"names":["sql","JWT_SECRET","app","express","__dirname"],"mappings":";;;;;;;AAGO,MAAM,aAA6B,CAAC,KAAK,QAAQ;AACtD,QAAM,WAAyB;AAAA,IAC7B,SAAS;AAAA,EAAA;AAEX,MAAI,OAAO,GAAG,EAAE,KAAK,QAAQ;AAC/B;ACLA,MAAMA,QAAM,KAAK,QAAQ,IAAI,oBAAqB;AAElD,eAAsB,eAAe,KAAc,KAAe;AAChE,MAAI;AACF,UAAM,EAAE,QAAQ,SAAA,IAAa,IAAI;AAEjC,QAAI,QAAQ;AACZ,UAAM,aAAuB,CAAA;AAC7B,UAAM,SAAgB,CAAA;AACtB,QAAI,aAAa;AAEjB,QAAI,UAAU,OAAO,WAAW,UAAU;AACxC,iBAAW,KAAK,eAAe,UAAU,EAAE;AAC3C,aAAO,KAAK,IAAI,MAAM,GAAG;AACzB;AAAA,IACF;AAEA,QAAI,YAAY,OAAO,aAAa,YAAY,aAAa,OAAO;AAClE,iBAAW,KAAK,eAAe,UAAU,EAAE;AAC3C,aAAO,KAAK,QAAQ;AACpB;AAAA,IACF;AAEA,QAAI,WAAW,SAAS,GAAG;AACzB,eAAS,UAAU,WAAW,KAAK,OAAO,CAAC;AAAA,IAC7C;AAEA,aAAS;AAET,UAAM,WAAW,OAAO,SAAS,IAC7B,MAAMA,MAAI,OAAO,MAAM,IACvB,MAAMA,MAAI,KAAK;AAEnB,QAAI,KAAK,QAAQ;AAAA,EACnB,SAAS,OAAO;AACd,YAAQ,MAAM,oDAAoD,KAAK;AACvE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,6DAA6D;AAAA,EAC7F;AACF;AAEA,eAAsB,eAAe,KAAc,KAAe;AAChE,MAAI;AACF,UAAM,EAAE,OAAO,IAAI;AACnB,UAAM,CAAC,OAAO,IAAI,MAAMA,0CAAwC,EAAE;AAElE,QAAI,CAAC,SAAS;AACZ,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B;AAAA,IACjE;AAEA,QAAI,KAAK,OAAO;AAAA,EAClB,SAAS,OAAO;AACd,YAAQ,MAAM,kDAAkD,KAAK;AACrE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oDAAoD;AAAA,EACpF;AACF;AAEA,eAAsB,cAAc,KAAc,KAAe;AAC/D,MAAI;AACF,UAAM,EAAE,MAAM,UAAU,OAAO,cAAc,WAAW,OAAO,kBAAkB,IAAI;AAErF,QAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,SAAS,iBAAiB,UAAa,CAAC,aAAa,UAAU,QAAW;AACnG,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2GAA2G;AAAA,IAClJ;AAEA,UAAM,CAAC,OAAO,IAAI,MAAMA;AAAAA;AAAAA,gBAEZ,IAAI,KAAK,QAAQ,KAAK,KAAK,KAAK,YAAY,KAAK,SAAS,KAAK,KAAK,KAAK,iBAAiB,IAAI;AAAA;AAAA;AAI1G,QAAI,OAAO,GAAG,EAAE,KAAK,OAAO;AAAA,EAC9B,SAAS,OAAO;AACd,YAAQ,MAAM,8CAA8C,KAAK;AACjE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8GAA8G;AAAA,EAC9I;AACF;AAEA,eAAsB,cAAc,KAAc,KAAe;AAC/D,MAAI;AACF,UAAM,EAAE,OAAO,IAAI;AACnB,UAAM,EAAE,MAAM,UAAU,OAAO,cAAc,WAAW,OAAO,kBAAkB,IAAI;AAErF,QAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,SAAS,iBAAiB,UAAa,CAAC,aAAa,UAAU,QAAW;AACnG,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2GAA2G;AAAA,IAClJ;AAEA,UAAM,CAAC,OAAO,IAAI,MAAMA;AAAAA;AAAAA,mBAET,IAAI;AAAA,uBACA,QAAQ;AAAA,oBACX,KAAK;AAAA,2BACE,YAAY;AAAA,wBACf,SAAS;AAAA,oBACb,KAAK;AAAA,4BACG,iBAAiB,IAAI;AAAA;AAAA,mBAE9B,EAAE;AAAA;AAAA;AAIjB,QAAI,CAAC,SAAS;AACZ,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+DAA+D;AAAA,IACtG;AAEA,QAAI,KAAK,OAAO;AAAA,EAClB,SAAS,OAAO;AACd,YAAQ,MAAM,2BAA2B,KAAK;AAC9C,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yFAAyF;AAAA,EACzH;AACF;AAEA,eAAsB,cAAc,KAAc,KAAe;AAC/D,MAAI;AACF,UAAM,EAAE,OAAO,IAAI;AAEnB,UAAM,CAAC,OAAO,IAAI,MAAMA;AAAAA,wCACY,EAAE;AAAA;AAGtC,QAAI,CAAC,SAAS;AACZ,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+DAA+D;AAAA,IACtG;AAEA,QAAI,KAAK,EAAE,SAAS,mCAAmC,SAAS;AAAA,EAClE,SAAS,OAAO;AACd,YAAQ,MAAM,2BAA2B,KAAK;AAC9C,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uEAAuE;AAAA,EACvG;AACF;AAEA,eAAsB,cAAc,KAAc,KAAe;AAC/D,MAAI;AACF,UAAM,aAAa,MAAMA;AAAAA;AAAAA;AAIzB,QAAI,KAAK,WAAW,IAAI,CAAA,MAAK,EAAE,QAAQ,CAAC;AAAA,EAC1C,SAAS,OAAO;AACd,YAAQ,MAAM,8BAA8B,KAAK;AACjD,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+DAA+D;AAAA,EAC/F;AACF;AC5IA,MAAMA,QAAM,KAAK,QAAQ,IAAI,oBAAqB;AAElD,eAAsB,mBAAmB;AACvC,MAAI;AACF,UAAMA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAUN,UAAMA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAgBN,UAAMA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAcN,UAAMA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAYN,QAAI;AACF,YAAMA;AAAAA,IACR,QAAQ;AAAA,IAER;AAEA,QAAI;AACF,YAAMA;AAAAA,IACR,QAAQ;AAAA,IAER;AAEA,QAAI;AACF,YAAMA;AAAAA,IACR,QAAQ;AAAA,IAER;AAEA,QAAI;AACF,YAAMA;AAAAA,IACR,QAAQ;AAAA,IAER;AAEA,QAAI;AACF,YAAMA;AAAAA,IACR,QAAQ;AAAA,IAER;AAGA,QAAI;AACF,YAAMA;AACN,cAAQ,IAAI,wCAAwC;AAAA,IACtD,SAAS,OAAO;AAAA,IAEhB;AAEA,UAAMA;AACN,UAAMA;AACN,UAAMA;AACN,UAAMA;AAEN,YAAQ,IAAI,wCAAwC;AAAA,EACtD,SAAS,OAAO;AACd,YAAQ,MAAM,qCAAqC,KAAK;AAAA,EAC1D;AACF;AAEA,iBAAA;AAEA,eAAsB,YAAY,KAAc,KAAe;AAC7D,MAAI;AACF,UAAM,EAAE,WAAW,UAAU,OAAO,OAAO,YAAY,aAAa,IAAI;AAGxE,UAAM,WAAY,IAAI,QAAQ,iBAAiB,GAAc,MAAM,GAAG,EAAE,CAAC,EAAE,KAAA,KAC1D,IAAI,QAAQ,iBACZ;AAEjB,QAAI,CAAC,aAAa,CAAC,YAAY,CAAC,SAAS,CAAC,SAAS,MAAM,WAAW,KAAK,CAAC,UAAU;AAClF,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+BAA+B;AAAA,IACtE;AAEA,UAAM,YAAY;AAClB,QAAI,CAAC,UAAU,KAAK,SAAS,KAAK,CAAC,UAAU,KAAK,QAAQ,GAAG;AAC3D,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wDAAwD;AAAA,IAC/F;AAGA,UAAM,aAAa,MAAM,QAAQ,OAAO,EAAE;AAC1C,UAAM,aAAa;AACnB,QAAI,CAAC,WAAW,KAAK,UAAU,GAAG;AAChC,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gCAAgC;AAAA,IACvE;AAGA,UAAM,gBAAgB;AACtB,QAAI,CAAC,cAAc,KAAK,SAAS,KAAA,CAAM,GAAG;AACxC,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oDAAoD;AAAA,IAC3F;AAGA,UAAM,gBAAgB,MAAMA;AAAAA,2DAC2B,SAAS,MAAM;AAAA;AAGtE,QAAI,iBAAiB,cAAc,SAAS,GAAG;AAC7C,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8FAA8F;AAAA,IACrI;AAGA,UAAM,oBAAoB,MAAMA;AAAAA,gDACY,SAAS,MAAM;AAAA;AAG3D,QAAI,qBAAqB,kBAAkB,SAAS,GAAG;AACrD,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,4HAA4H;AAAA,IACnK;AAEA,UAAM,CAAC,KAAK,IAAI,MAAMA;AAAAA;AAAAA,gBAEV,SAAS,KAAA,CAAM,KAAK,SAAS,KAAK,QAAQ,KAAK,UAAU,KAAK,UAAU,gBAAgB,QAAQ;AAAA;AAAA;AAI5G,eAAW,QAAQ,OAAO;AACxB,YAAMA;AAAAA;AAAAA,kBAEM,MAAM,EAAE,KAAK,KAAK,SAAS,KAAK,KAAK,WAAW,KAAK,KAAK,eAAe,KAAK,KAAK,YAAY,KAAK,KAAK,eAAe,KAAK,KAAK,QAAQ;AAAA;AAAA,IAExJ;AAEA,UAAM,aAAa,MAAMA;AAAAA,mDACsB,MAAM,EAAE;AAAA;AAIvD,UAAM,aAAa,QAAQ,IAAI;AAC/B,UAAM,oBAAoB,QAAQ,IAAI;AAEtC,QAAI,YAAY;AACd,UAAI;AACF,cAAM,UAAU;AAAA,UACd,MAAM;AAAA,UACN,OAAO;AAAA,UACP,OAAO;AAAA,YACL,UAAU,MAAM;AAAA,YAChB,IAAI,MAAM;AAAA,YACV,WAAW,MAAM;AAAA,YACjB,UAAU,MAAM;AAAA,YAChB,OAAO,MAAM;AAAA,YACb,YAAY,MAAM;AAAA,YAClB,QAAQ,MAAM;AAAA,YACd,WAAW,MAAM;AAAA,YACjB,OAAO,WAAW,IAAI,CAAC,UAAe;AAAA,cACpC,aAAa,KAAK;AAAA,cAClB,iBAAiB,KAAK;AAAA,cACtB,cAAc,KAAK;AAAA,cACnB,UAAU,KAAK;AAAA,YAAA,EACf;AAAA,UAAA;AAAA,QACJ;AAEF,cAAM,MAAM,YAAY;AAAA,UACtB,QAAQ;AAAA,UACR,SAAS,EAAE,gBAAgB,mBAAA;AAAA,UAC3B,MAAM,KAAK,UAAU,OAAO;AAAA,QAAA,CAC7B;AACD,gBAAQ,IAAI,uCAAuC,MAAM,EAAE;AAAA,MAC7D,SAAS,cAAc;AACrB,gBAAQ,MAAM,mCAAmC,YAAY;AAAA,MAC/D;AAAA,IACF;AAEA,QAAI,mBAAmB;AACrB,UAAI;AACF,cAAM,eAAe,WAClB,IAAI,CAAC,UAAe;AAAA,UACnB,MAAM,KAAK;AAAA,UACX,UAAU,KAAK;AAAA,UACf,OAAO,KAAK;AAAA,UACZ,UAAU,KAAK;AAAA,UACf,UAAU,KAAK,gBAAgB,KAAK;AAAA,QAAA,EACpC,EACD,OAAO,CAAC,KAAK,SAAS;AACrB,iBAAO,MAAM,OAAO,KAAK,IAAI;AAAA,kBAAuB,KAAK,QAAQ;AAAA,iBAAoB,KAAK,QAAQ;AAAA,sBAA0B,KAAK,MAAM,gBAAgB;AAAA,oBAAwB,KAAK,SAAS,gBAAgB;AAAA;AAAA;AAAA,QAC/M,GAAG,EAAE;AAEP,cAAM,iBAAiB,MAAM,QAAQ,QAAQ,GAAG;AAChD,cAAM,iBAAgB,oBAAI,KAAA,GAAO,mBAAmB,SAAS;AAAA,UAC3D,SAAS;AAAA,UACT,MAAM;AAAA,UACN,OAAO;AAAA,UACP,KAAK;AAAA,UACL,MAAM;AAAA,UACN,QAAQ;AAAA,QAAA,CACT;AAED,cAAM,MAAM,mBAAmB;AAAA,UAC7B,QAAQ;AAAA,UACR,SAAS,EAAE,gBAAgB,mBAAA;AAAA,UAC3B,MAAM,KAAK,UAAU;AAAA,YACnB,SAAS;AAAA,YACT,QAAQ;AAAA,cACN;AAAA,gBACE,OAAO,gBAAgB,MAAM,EAAE;AAAA,gBAC/B,aAAa;AAAA,gBACb,OAAO;AAAA,gBACP,QAAQ;AAAA,kBACN;AAAA,oBACE,MAAM;AAAA,oBACN,OAAO;AAAA,oBACP,QAAQ;AAAA,kBAAA;AAAA,kBAEV;AAAA,oBACE,MAAM;AAAA,oBACN,OAAO,GAAG,SAAS,IAAI,QAAQ;AAAA,oBAC/B,QAAQ;AAAA,kBAAA;AAAA,kBAEV;AAAA,oBACE,MAAM;AAAA,oBACN,OAAO,KAAK,cAAc;AAAA,oBAC1B,QAAQ;AAAA,kBAAA;AAAA,kBAEV;AAAA,oBACE,MAAM;AAAA,oBACN,OAAO,KAAK,MAAM,SAAS;AAAA,oBAC3B,QAAQ;AAAA,kBAAA;AAAA,kBAEV;AAAA,oBACE,MAAM;AAAA,oBACN,OAAO;AAAA,oBACP,QAAQ;AAAA,kBAAA;AAAA,kBAEV;AAAA,oBACE,MAAM,MAAM,MAAM,MAAM,YAAY,MAAM,SAAS,IAAI,MAAM,EAAE;AAAA,oBAC/D,OAAO,gBAAgB;AAAA,oBACvB,QAAQ;AAAA,kBAAA;AAAA,kBAEV;AAAA,oBACE,MAAM;AAAA,oBACN,OAAO;AAAA,oBACP,QAAQ;AAAA,kBAAA;AAAA,kBAEV;AAAA,oBACE,MAAM;AAAA,oBACN,OAAO,OAAO,WAAW,eAAA,CAAgB;AAAA,oBACzC,QAAQ;AAAA,kBAAA;AAAA,kBAEV;AAAA,oBACE,MAAM;AAAA,oBACN,OAAO;AAAA,oBACP,QAAQ;AAAA,kBAAA;AAAA,gBACV;AAAA,gBAEF,QAAQ;AAAA,kBACN,MAAM;AAAA,kBACN,UAAU;AAAA,gBAAA;AAAA,gBAEZ,YAAW,oBAAI,KAAA,GAAO,YAAA;AAAA,cAAY;AAAA,YACpC;AAAA,UACF,CACD;AAAA,QAAA,CACF;AAAA,MACH,SAAS,cAAc;AACrB,gBAAQ,MAAM,2CAA2C,YAAY;AAAA,MACvE;AAAA,IACF;AAEA,QAAI,OAAO,GAAG,EAAE,KAAK;AAAA,MACnB,GAAG;AAAA,MACH,OAAO;AAAA,IAAA,CACR;AAAA,EACH,SAAS,OAAO;AACd,YAAQ,MAAM,iDAAiD,KAAK;AACpE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,sFAAsF;AAAA,EACtH;AACF;AAEA,eAAsB,aAAa,KAAc,KAAe;AAC9D,MAAI;AACF,UAAM,EAAE,WAAW,IAAI;AAEvB,QAAI;AACJ,QAAI,UAAU,OAAO,WAAW,YAAY,WAAW,OAAO;AAC5D,eAAS,MAAMA;AAAAA,8CACyB,MAAM;AAAA;AAAA,IAEhD,OAAO;AACL,eAAS,MAAMA;AAAAA,IACjB;AAEA,UAAM,kBAAkB,MAAM,QAAQ;AAAA,MACpC,OAAO,IAAI,OAAO,UAAe;AAC/B,cAAM,QAAQ,MAAMA;AAAAA,uDAC2B,MAAM,EAAE;AAAA;AAEvD,eAAO;AAAA,UACL,GAAG;AAAA,UACH;AAAA,QAAA;AAAA,MAEJ,CAAC;AAAA,IAAA;AAGH,QAAI,KAAK,eAAe;AAAA,EAC1B,SAAS,OAAO;AACd,YAAQ,MAAM,oDAAoD,KAAK;AACvE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gDAAgD;AAAA,EAChF;AACF;AAEA,eAAsB,aAAa,KAAc,KAAe;AAC9D,MAAI;AACF,UAAM,EAAE,OAAO,IAAI;AAEnB,UAAM,CAAC,KAAK,IAAI,MAAMA,wCAAsC,EAAE;AAC9D,QAAI,CAAC,OAAO;AACV,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wBAAwB;AAAA,IAC/D;AAEA,UAAM,QAAQ,MAAMA,mDAAiD,EAAE;AAEvE,QAAI,KAAK;AAAA,MACP,GAAG;AAAA,MACH;AAAA,IAAA,CACD;AAAA,EACH,SAAS,OAAO;AACd,YAAQ,MAAM,qDAAqD,KAAK;AACxE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iDAAiD;AAAA,EACjF;AACF;AAEA,eAAsB,kBAAkB,KAAc,KAAe;AACnE,MAAI;AACF,UAAM,EAAE,OAAO,IAAI;AACnB,UAAM,EAAE,QAAQ,UAAU,mBAAA,IAAuB,IAAI;AAErD,QAAI,CAAC,UAAU,CAAC,CAAC,WAAW,aAAa,WAAW,EAAE,SAAS,MAAM,GAAG;AACtE,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qFAAqF;AAAA,IAC5H;AAEA,QAAI;AACJ,QAAI,WAAW,eAAe,UAAU;AACtC,OAAC,KAAK,IAAI,MAAMA;AAAAA;AAAAA,uBAEC,MAAM,oBAAoB,QAAQ;AAAA,qBACpC,EAAE;AAAA;AAAA;AAAA,IAGnB,WAAW,WAAW,eAAe,oBAAoB;AACvD,OAAC,KAAK,IAAI,MAAMA;AAAAA;AAAAA,uBAEC,MAAM,2BAA2B,kBAAkB,oBAAoB,QAAQ;AAAA,qBACjF,EAAE;AAAA;AAAA;AAAA,IAGnB,OAAO;AACL,OAAC,KAAK,IAAI,MAAMA;AAAAA;AAAAA,uBAEC,MAAM;AAAA,qBACR,EAAE;AAAA;AAAA;AAAA,IAGnB;AAEA,QAAI,CAAC,OAAO;AACV,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2EAA2E;AAAA,IAClH;AAGA,UAAM,aAAa,MAAMA;AAAAA,mDACsB,MAAM,EAAE;AAAA;AAIvD,UAAM,aAAa,QAAQ,IAAI;AAC/B,UAAM,oBAAoB,QAAQ,IAAI;AAEtC,QAAI,YAAY;AACd,UAAI;AACF,cAAM,iBAAgB,oBAAI,KAAA,GAAO,mBAAmB,SAAS;AAAA,UAC3D,SAAS;AAAA,UACT,MAAM;AAAA,UACN,OAAO;AAAA,UACP,KAAK;AAAA,UACL,MAAM;AAAA,UACN,QAAQ;AAAA,QAAA,CACT;AAGD,cAAM,wBAAmD;AAAA,UACvD,sBAAsB;AAAA,UACtB,kBAAkB;AAAA,UAClB,0BAA0B;AAAA,QAAA;AAG5B,cAAM,cAAc,WAAW,cAAc,oBAAoB;AACjE,cAAM,cAAc,WAAW,cAAc,MAAM;AAEnD,cAAM,YAAiB;AAAA,UACrB,UAAU,MAAM;AAAA,UAChB,IAAI,MAAM;AAAA,UACV,WAAW,MAAM;AAAA,UACjB,UAAU,MAAM;AAAA,UAChB,OAAO,MAAM;AAAA,UACb,YAAY,MAAM;AAAA,UAClB;AAAA,UACA,WAAW,MAAM;AAAA,UACjB,aAAa,GAAG,YAAY,SAAS,KAAK,aAAa;AAAA,UACvD,OAAO,WAAW,IAAI,CAAC,UAAe;AAAA,YACpC,aAAa,KAAK;AAAA,YAClB,iBAAiB,KAAK;AAAA,YACtB,cAAc,KAAK;AAAA,YACnB,UAAU,KAAK;AAAA,UAAA,EACf;AAAA,QAAA;AAGJ,YAAI,WAAW,eAAgB,MAAc,qBAAqB;AAChE,gBAAM,SAAU,MAAc;AAC9B,oBAAU,qBAAqB,sBAAsB,MAAM,KAAK;AAAA,QAClE;AAEA,cAAM,UAAU;AAAA,UACd,MAAM,WAAW,cAAc,oBAAoB;AAAA,UACnD,OAAO,GAAG,WAAW,IAAI,WAAW,IAAI,WAAW;AAAA,UACnD,OAAO;AAAA,QAAA;AAGT,cAAM,MAAM,YAAY;AAAA,UACtB,QAAQ;AAAA,UACR,SAAS,EAAE,gBAAgB,mBAAA;AAAA,UAC3B,MAAM,KAAK,UAAU,OAAO;AAAA,QAAA,CAC7B;AACD,gBAAQ,IAAI,0BAA0B,MAAM,EAAE,cAAc,MAAM,EAAE;AAAA,MACtE,SAAS,cAAc;AACrB,gBAAQ,MAAM,6CAA6C,YAAY;AAAA,MACzE;AAAA,IACF;AAEA,QAAI,mBAAmB;AACrB,UAAI;AACF,cAAM,eAAe,WAClB,IAAI,CAAC,UAAe;AAAA,UACnB,MAAM,KAAK;AAAA,UACX,UAAU,KAAK;AAAA,UACf,OAAO,KAAK;AAAA,UACZ,UAAU,KAAK;AAAA,UACf,UAAU,KAAK,gBAAgB,KAAK;AAAA,QAAA,EACpC,EACD,OAAO,CAAC,KAAa,SAAc;AAClC,iBAAO,MAAM,OAAO,KAAK,IAAI;AAAA,kBAAuB,KAAK,QAAQ;AAAA,iBAAoB,KAAK,QAAQ;AAAA,sBAA0B,KAAK,MAAM,gBAAgB;AAAA,oBAAwB,KAAK,SAAS,gBAAgB;AAAA;AAAA;AAAA,QAC/M,GAAG,EAAE;AAEP,cAAM,cAAc,WAAW,cAAc,MAAM;AACnD,cAAM,aAAa,WAAW,cAAc,oBAAoB;AAChE,cAAM,aAAa,WAAW,cAAc,QAAQ;AAEpD,cAAM,qBAAoB,oBAAI,KAAA,GAAO,mBAAmB,SAAS;AAAA,UAC/D,SAAS;AAAA,UACT,MAAM;AAAA,UACN,OAAO;AAAA,UACP,KAAK;AAAA,UACL,MAAM;AAAA,UACN,QAAQ;AAAA,QAAA,CACT;AAED,YAAI,iBAAsB;AAAA,UACxB,SAAS,GAAG,WAAW,MAAM,UAAU,MAAM,WAAW;AAAA,UACxD,QAAQ;AAAA,YACN;AAAA,cACE,OAAO,gBAAgB,MAAM,EAAE;AAAA,cAC/B,aAAa,WAAW,cAAc,0CAA0C;AAAA,cAChF,OAAO;AAAA,cACP,QAAQ;AAAA,gBACN;AAAA,kBACE,MAAM;AAAA,kBACN,OAAO;AAAA,kBACP,QAAQ;AAAA,gBAAA;AAAA,gBAEV;AAAA,kBACE,MAAM;AAAA,kBACN,OAAO,GAAG,MAAM,UAAU,IAAI,MAAM,SAAS;AAAA,kBAC7C,QAAQ;AAAA,gBAAA;AAAA,gBAEV;AAAA,kBACE,MAAM;AAAA,kBACN,OAAO,KAAK,MAAM,KAAK;AAAA,kBACvB,QAAQ;AAAA,gBAAA;AAAA,gBAEV;AAAA,kBACE,MAAM;AAAA,kBACN,OAAO,KAAK,MAAM,SAAS;AAAA,kBAC3B,QAAQ;AAAA,gBAAA;AAAA,gBAEV;AAAA,kBACE,MAAM;AAAA,kBACN,OAAO;AAAA,kBACP,QAAQ;AAAA,gBAAA;AAAA,gBAEV;AAAA,kBACE,MAAM;AAAA,kBACN,OAAO,gBAAgB;AAAA,kBACvB,QAAQ;AAAA,gBAAA;AAAA,gBAEV;AAAA,kBACE,MAAM;AAAA,kBACN,OAAO;AAAA,kBACP,QAAQ;AAAA,gBAAA;AAAA,gBAEV;AAAA,kBACE,MAAM;AAAA,kBACN,OAAO,KAAK,MAAM,YAAY,gBAAgB;AAAA,kBAC9C,QAAQ;AAAA,gBAAA;AAAA,gBAEV;AAAA,kBACE,MAAM;AAAA,kBACN,OAAO,GAAG,YAAY,SAAS,OAAO,iBAAiB;AAAA,kBACvD,QAAQ;AAAA,gBAAA;AAAA,cACV;AAAA,cAEF,QAAQ;AAAA,gBACN,MAAM;AAAA,gBACN,UAAU;AAAA,cAAA;AAAA,cAEZ,YAAW,oBAAI,KAAA,GAAO,YAAA;AAAA,YAAY;AAAA,UACpC;AAAA,QACF;AAGF,YAAI,WAAW,eAAgB,MAAc,qBAAqB;AAChE,gBAAM,wBAAmD;AAAA,YACvD,sBAAsB;AAAA,YACtB,kBAAkB;AAAA,YAClB,0BAA0B;AAAA,UAAA;AAE5B,gBAAM,SAAU,MAAc;AAC9B,gBAAM,gBAAgB,sBAAsB,MAAM,KAAK;AACvD,yBAAe,OAAO,CAAC,EAAE,OAAO,KAAK;AAAA,YACnC,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,UAAA,CACT;AAAA,QACH;AAEA,cAAM,MAAM,mBAAmB;AAAA,UAC7B,QAAQ;AAAA,UACR,SAAS,EAAE,gBAAgB,mBAAA;AAAA,UAC3B,MAAM,KAAK,UAAU,cAAc;AAAA,QAAA,CACpC;AACD,gBAAQ,IAAI,kCAAkC,MAAM,EAAE,cAAc,MAAM,EAAE;AAAA,MAC9E,SAAS,cAAc;AACrB,gBAAQ,MAAM,2CAA2C,YAAY;AAAA,MACvE;AAAA,IACF;AAEA,QAAI,KAAK,KAAK;AAAA,EAChB,SAAS,OAAO;AACd,YAAQ,MAAM,8DAA8D,KAAK;AACjF,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yFAAyF;AAAA,EACzH;AACF;AAEA,eAAsB,YAAY,KAAc,KAAe;AAC7D,MAAI;AACF,UAAM,EAAE,OAAO,IAAI;AAEnB,UAAM,CAAC,KAAK,IAAI,MAAMA;AAAAA,sCACY,EAAE;AAAA;AAGpC,QAAI,CAAC,OAAO;AACV,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,6EAA6E;AAAA,IACpH;AAEA,QAAI,KAAK,EAAE,SAAS,mCAAA,CAAoC;AAAA,EAC1D,SAAS,OAAO;AACd,YAAQ,MAAM,oDAAoD,KAAK;AACvE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8DAA8D;AAAA,EAC9F;AACF;ACrmBA,MAAMC,eAAa,QAAQ,IAAI;AAC/B,MAAMD,QAAM,KAAK,QAAQ,IAAI,oBAAqB;AAElD,IAAI,CAACC,cAAY;AACf,QAAM,IAAI,MAAM,gEAAgE;AAClF;AAUA,eAAsB,UAAU,KAAc,KAAe,MAAoB;AAC/E,QAAM,aAAa,IAAI,QAAQ;AAE/B,MAAI,CAAC,cAAc,CAAC,WAAW,WAAW,SAAS,GAAG;AACpD,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yEAAyE;AAAA,EAChH;AAEA,QAAM,QAAQ,WAAW,UAAU,CAAC;AAEpC,MAAI;AACF,UAAM,UAAU,IAAI,OAAO,OAAOA,YAAU;AAE5C,QAAI,CAAC,QAAQ,eAAe;AAC1B,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oDAAoD;AAAA,IAC3F;AAIA,QAAI;AACF,YAAM,SAAS,MAAMD;AAAAA,6DACkC,QAAQ,MAAM;AAAA;AAGrE,UAAI,CAAC,UAAU,OAAO,WAAW,GAAG;AAElC,eAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qFAAqF;AAAA,MAC5H;AAGA,cAAQ,cAAc,OAAO,CAAC,EAAE;AAAA,IAClC,SAAS,SAAS;AAChB,cAAQ,MAAM,6DAA6D,OAAO;AAAA,IAEpF;AAEA,QAAI,OAAO;AACX,SAAA;AAAA,EACF,SAAS,OAAO;AACd,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iDAAiD;AAAA,EACxF;AACF;AAOO,SAAS,kBAAkB,UAA8B,YAAkE;AAChI,SAAO,CAAC,KAAc,KAAe,SAAuB;AAC1D,QAAI,CAAC,IAAI,MAAM;AACb,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wDAAwD;AAAA,IAC/F;AAEA,UAAM,cAAc,IAAI,KAAK;AAE7B,QAAI,CAAC,aAAa;AAChB,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8DAA8D;AAAA,IACrG;AAEA,UAAM,sBAAsB,YAAY,QAAQ;AAEhD,QAAI,CAAC,uBAAuB,CAAE,oBAAgD,UAAU,GAAG;AACzF,YAAM,eAAuC;AAAA,QAC3C,QAAQ;AAAA,QACR,QAAQ;AAAA,QACR,QAAQ;AAAA,QACR,MAAM;AAAA,QACN,UAAU;AAAA,QACV,QAAQ;AAAA,MAAA;AAEV,YAAM,iBAAyC;AAAA,QAC7C,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,OAAO;AAAA,MAAA;AAET,YAAM,SAAS,aAAa,UAAU,KAAK;AAC3C,YAAM,eAAe,eAAe,QAAQ,KAAK;AACjD,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK;AAAA,QAC1B,OAAO,4DAA4D,MAAM,IAAI,YAAY;AAAA,MAAA,CAC1F;AAAA,IACH;AAEA,SAAA;AAAA,EACF;AACF;AAEO,SAAS,yBAAyB,YAA+B;AACtE,SAAO,kBAAkB,YAAY,UAAU;AACjD;AAEO,SAAS,uBAAuB,YAA6B;AAClE,SAAO,kBAAkB,UAAU,UAAU;AAC/C;AAEO,SAAS,sBAAsB,YAA4B;AAChE,SAAO,kBAAkB,SAAS,UAAU;AAC9C;AChHA,MAAM,aAAa,QAAQ,IAAI;AAE/B,IAAI,CAAC,YAAY;AACf,QAAM,IAAI,MAAM,gEAAgE;AAClF;AAEA,MAAMA,QAAM,KAAK,QAAQ,IAAI,oBAAqB;AASlD,eAAsB,MAAM,KAAc,KAAe;AACvD,QAAM,EAAE,UAAU,UAAA,IAAc,IAAI;AAEpC,MAAI,CAAC,YAAY,CAAC,WAAW;AAC3B,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uDAAuD;AAAA,EAC9F;AAEA,MAAI;AACF,UAAM,SAAS,MAAMA;AAAAA;AAAAA;AAAAA,yBAGA,QAAQ,qBAAqB,SAAS;AAAA;AAAA;AAI3D,QAAI,CAAC,UAAU,OAAO,WAAW,GAAG;AAClC,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yCAAyC;AAAA,IAChF;AAEA,UAAM,OAAO,OAAO,CAAC;AAErB,UAAM,QAAQ,IAAI;AAAA,MAChB;AAAA,QACE,QAAQ,KAAK;AAAA,QACb,UAAU,KAAK;AAAA,QACf,aAAa,KAAK;AAAA,QAClB,eAAe;AAAA,MAAA;AAAA,MAEjB;AAAA,MACA,EAAE,WAAW,MAAA;AAAA,IAAM;AAGrB,QAAI,KAAK;AAAA,MACP;AAAA,MACA,MAAM;AAAA,QACJ,IAAI,KAAK;AAAA,QACT,UAAU,KAAK;AAAA,QACf,aAAa,KAAK;AAAA,MAAA;AAAA,IACpB,CACD;AAAA,EACH,SAAS,OAAO;AACd,YAAQ,MAAM,2BAA2B,KAAK;AAC9C,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yEAAyE;AAAA,EACzG;AACF;AAEA,eAAsB,eAAe,KAAc,KAAe;AAChE,QAAM,aAAa,IAAI,QAAQ;AAE/B,MAAI,CAAC,cAAc,CAAC,WAAW,WAAW,SAAS,GAAG;AACpD,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8BAA8B;AAAA,EACrE;AAEA,QAAM,QAAQ,WAAW,UAAU,CAAC;AAEpC,MAAI;AACF,UAAM,UAAU,IAAI,OAAO,OAAO,UAAU;AAE5C,UAAM,SAAS,MAAMA;AAAAA;AAAAA;AAAAA,mBAGN,QAAQ,MAAM;AAAA;AAAA;AAI7B,QAAI,CAAC,UAAU,OAAO,WAAW,GAAG;AAClC,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oCAAoC;AAAA,IAC3E;AAEA,UAAM,OAAO,OAAO,CAAC;AAIrB,UAAM,cAAc,KAAK,eAAe,CAAA;AACxC,UAAM,mBAAmB,OAAO,OAAO,WAAW,EAAE,KAAK,CAAC,aAAkB;AAC1E,UAAI,OAAO,aAAa,UAAU;AAChC,eAAO,OAAO,OAAO,QAAQ,EAAE,KAAK,CAAC,SAAc,SAAS,IAAI;AAAA,MAClE;AACA,aAAO,aAAa;AAAA,IACtB,CAAC;AAED,QAAI,CAAC,kBAAkB;AACrB,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gEAAgE;AAAA,IACvG;AAEA,QAAI,KAAK,IAAI;AAAA,EACf,SAAS,OAAO;AACd,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iCAAiC;AAAA,EACxE;AACF;AC1GA,MAAMA,QAAM,KAAK,QAAQ,IAAI,oBAAqB;AA2ClD,MAAM,sBAAuC;AAAA,EAC3C,UAAU,EAAE,MAAM,MAAM,QAAQ,OAAO,QAAQ,OAAO,QAAQ,MAAA;AAAA,EAC9D,QAAQ,EAAE,MAAM,MAAM,UAAU,OAAO,QAAQ,OAAO,QAAQ,MAAA;AAAA,EAC9D,OAAO,EAAE,MAAM,OAAO,QAAQ,OAAO,QAAQ,OAAO,QAAQ,MAAA;AAAA,EAC5D,YAAY,EAAE,MAAM,OAAO,eAAe,MAAA;AAAA,EAC1C,eAAe,EAAE,MAAM,OAAO,QAAQ,OAAO,QAAQ,OAAO,QAAQ,MAAA;AACtE;AAEA,MAAM,mBAAoC;AAAA,EACxC,UAAU,EAAE,MAAM,MAAM,QAAQ,MAAM,QAAQ,MAAM,QAAQ,KAAA;AAAA,EAC5D,QAAQ,EAAE,MAAM,MAAM,UAAU,MAAM,QAAQ,MAAM,QAAQ,KAAA;AAAA,EAC5D,OAAO,EAAE,MAAM,MAAM,QAAQ,MAAM,QAAQ,MAAM,QAAQ,KAAA;AAAA,EACzD,YAAY,EAAE,MAAM,MAAM,eAAe,KAAA;AAAA,EACzC,eAAe,EAAE,MAAM,MAAM,QAAQ,MAAM,QAAQ,MAAM,QAAQ,KAAA;AACnE;AAEA,eAAsB,iBAAiB;AACrC,MAAI;AACF,UAAMA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAAAA;AAaN,UAAM,cAAc,MAAMA;AAAAA;AAAAA;AAAAA;AAAAA;AAM1B,QAAI,YAAY,WAAW,GAAG;AAC5B,YAAMA;AAAAA;AAAAA;AAAAA;AAAAA,IAIR;AAEA,UAAM,gBAAgB,MAAMA;AAE5B,QAAI,cAAc,WAAW,GAAG;AAC9B,YAAMA;AAAAA;AAAAA,+CAEmC,KAAK,UAAU,gBAAgB,CAAC;AAAA;AAEzE,cAAQ,IAAI,uDAAuD;AAAA,IACrE;AAEA,YAAQ,IAAI,4CAA4C;AAAA,EAC1D,SAAS,OAAO;AACd,YAAQ,MAAM,+DAA+D,KAAK;AAAA,EACpF;AACF;AAEA,eAAsB,YAAY,KAAc,KAAe;AAC7D,MAAI;AACF,UAAM,QAAQ,MAAMA;AAAAA;AAAAA;AAAAA;AAAAA;AAKpB,QAAI,KAAK,KAAK;AAAA,EAChB,SAAS,OAAO;AACd,YAAQ,MAAM,uDAAuD,KAAK;AAC1E,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yEAAyE;AAAA,EACzG;AACF;AAEA,eAAsB,YAAY,KAAc,KAAe;AAC7D,QAAM,EAAE,OAAO,IAAI;AAEnB,MAAI;AACF,UAAM,QAAQ,MAAMA;AAAAA;AAAAA;AAAAA,mBAGL,SAAS,EAAE,CAAC;AAAA;AAG3B,QAAI,MAAM,WAAW,GAAG;AACtB,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wEAAwE;AAAA,IAC/G;AAEA,QAAI,KAAK,MAAM,CAAC,CAAC;AAAA,EACnB,SAAS,OAAO;AACd,YAAQ,MAAM,uDAAuD,KAAK;AAC1E,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gDAAgD;AAAA,EAChF;AACF;AAEA,eAAsB,WAAW,KAAc,KAAe;AAC5D,QAAM,EAAE,UAAU,YAAY,WAAW,YAAA,IAAgB,IAAI;AAE7D,MAAI,CAAC,YAAY,CAAC,YAAY;AAC5B,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wDAAwD;AAAA,EAC/F;AAEA,MAAI,aAAa,CAAC,QAAQ,KAAK,SAAS,GAAG;AACzC,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oDAAoD;AAAA,EAC3F;AAEA,MAAI;AACF,UAAM,eAAe,MAAMA;AAAAA,oDACqB,QAAQ;AAAA;AAGxD,QAAI,aAAa,SAAS,GAAG;AAC3B,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0EAA0E;AAAA,IACjH;AAEA,QAAI,WAAW;AACb,YAAM,aAAa,MAAMA;AAAAA,uDACwB,SAAS;AAAA;AAE1D,UAAI,WAAW,SAAS,GAAG;AACzB,eAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,kEAAkE;AAAA,MACzG;AAAA,IACF;AAEA,UAAM,kBAAkB,eAAe;AAEvC,UAAM,SAAS,MAAMA;AAAAA;AAAAA,gBAET,QAAQ,KAAK,UAAU,KAAK,aAAa,IAAI,KAAK,KAAK,UAAU,eAAe,CAAC;AAAA;AAAA;AAI7F,QAAI,OAAO,GAAG,EAAE,KAAK,OAAO,CAAC,CAAC;AAAA,EAChC,SAAS,OAAO;AACd,YAAQ,MAAM,mDAAmD,KAAK;AACtE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,sHAAsH;AAAA,EACtJ;AACF;AAEA,eAAsB,WAAW,KAAc,KAAe;AAC5D,QAAM,EAAE,OAAO,IAAI;AACnB,QAAM,EAAE,UAAU,YAAY,WAAW,YAAA,IAAgB,IAAI;AAE7D,MAAI;AACF,UAAM,eAAe,MAAMA;AAAAA,8CACe,SAAS,EAAE,CAAC;AAAA;AAGtD,QAAI,aAAa,WAAW,GAAG;AAC7B,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wEAAwE;AAAA,IAC/G;AAEA,QAAI,aAAa,CAAC,QAAQ,KAAK,SAAS,GAAG;AACzC,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oDAAoD;AAAA,IAC3F;AAEA,QAAI,UAAU;AACZ,YAAM,gBAAgB,MAAMA;AAAAA,sDACoB,QAAQ,cAAc,SAAS,EAAE,CAAC;AAAA;AAElF,UAAI,cAAc,SAAS,GAAG;AAC5B,eAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0EAA0E;AAAA,MACjH;AAAA,IACF;AAEA,QAAI,cAAc,UAAa,cAAc,MAAM;AACjD,YAAM,cAAc,MAAMA;AAAAA,uDACuB,SAAS,cAAc,SAAS,EAAE,CAAC;AAAA;AAEpF,UAAI,YAAY,SAAS,GAAG;AAC1B,eAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,kEAAkE;AAAA,MACzG;AAAA,IACF;AAEA,UAAM,aAAa,CAAA;AAEnB,QAAI,aAAa,QAAW;AAC1B,iBAAW,KAAK,eAAe,QAAQ,GAAG;AAAA,IAC5C;AACA,QAAI,eAAe,QAAW;AAC5B,iBAAW,KAAK,iBAAiB,UAAU,GAAG;AAAA,IAChD;AACA,QAAI,cAAc,QAAW;AAC3B,iBAAW,KAAK,eAAe,YAAY,IAAI,SAAS,MAAM,MAAM,EAAE;AAAA,IACxE;AACA,QAAI,gBAAgB,QAAW;AAC7B,iBAAW,KAAK,kBAAkB,KAAK,UAAU,WAAW,CAAC,GAAG;AAAA,IAClE;AAEA,QAAI,WAAW,WAAW,GAAG;AAC3B,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0CAA0C;AAAA,IACjF;AAEA,eAAW,KAAK,gCAAgC;AAEhD,UAAM,SAAS,MAAMA;AAAAA;AAAAA,YAEbA,MAAI,WAAW,KAAK,IAAI,CAAC,CAAC;AAAA,mBACnB,SAAS,EAAE,CAAC;AAAA;AAAA;AAI3B,QAAI,KAAK,OAAO,CAAC,CAAC;AAAA,EACpB,SAAS,OAAO;AACd,YAAQ,MAAM,sDAAsD,KAAK;AACzE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,sFAAsF;AAAA,EACtH;AACF;AAEA,eAAsB,WAAW,KAAc,KAAe;AAC5D,QAAM,EAAE,OAAO,IAAI;AAEnB,MAAI;AACF,UAAM,aAAa,MAAMA;AAEzB,QAAI,SAAS,WAAW,CAAC,EAAE,KAAK,KAAK,GAAG;AACtC,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,kGAAkG;AAAA,IACzI;AAEA,UAAM,SAAS,MAAMA;AAAAA;AAAAA,mBAEN,SAAS,EAAE,CAAC;AAAA;AAAA;AAI3B,QAAI,OAAO,WAAW,GAAG;AACvB,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wEAAwE;AAAA,IAC/G;AAEA,QAAI,KAAK,EAAE,SAAS,qCAAA,CAAsC;AAAA,EAC5D,SAAS,OAAO;AACd,YAAQ,MAAM,sDAAsD,KAAK;AACzE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oDAAoD;AAAA,EACpF;AACF;ACrRA,MAAMA,QAAM,KAAK,QAAQ,IAAI,oBAAqB;AAElD,eAAsB,gBAAgB,KAAc,KAAe;AACjE,MAAI;AACF,UAAM,MAAM,MAAMA;AAAAA;AAAAA;AAGlB,QAAI,KAAK,GAAG;AAAA,EACd,SAAS,OAAO;AACd,YAAQ,MAAM,qDAAqD,KAAK;AACxE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2CAA2C;AAAA,EAC3E;AACF;AAEA,eAAsB,MAAM,KAAc,KAAe;AACvD,MAAI;AACF,UAAM,EAAE,UAAU,OAAA,IAAW,IAAI;AACjC,UAAM,WAAW,IAAI,MAAM,YAAY;AAEvC,QAAI,CAAC,UAAU;AACb,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB;AAAA,IAC9D;AAGA,UAAM,gBAAgB;AACtB,QAAI,CAAC,cAAc,KAAK,SAAS,KAAA,CAAM,GAAG;AACxC,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oDAAoD;AAAA,IAC3F;AAEA,UAAM,CAAC,QAAQ,IAAI,MAAMA;AAAAA;AAAAA,gBAEb,SAAS,MAAM,KAAK,UAAU,IAAI,KAAK,QAAQ;AAAA;AAAA;AAAA;AAK3D,QAAI,OAAO,GAAG,EAAE,KAAK,QAAQ;AAAA,EAC/B,SAAS,OAAO;AACd,YAAQ,MAAM,2CAA2C,KAAK;AAC9D,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uCAAuC;AAAA,EACvE;AACF;AAEA,eAAsB,QAAQ,KAAc,KAAe;AACzD,MAAI;AACF,UAAM,EAAE,aAAa,IAAI;AAEzB,QAAI,CAAC,UAAU;AACb,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB;AAAA,IAC9D;AAGA,UAAM,gBAAgB;AACtB,QAAI,CAAC,cAAc,KAAK,SAAS,KAAA,CAAM,GAAG;AACxC,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oDAAoD;AAAA,IAC3F;AAEA,UAAM,CAAC,MAAM,IAAI,MAAMA;AAAAA,wDAC6B,SAAS,MAAM;AAAA;AAGnE,QAAI,CAAC,QAAQ;AACX,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0DAA0D;AAAA,IACjG;AAEA,QAAI,KAAK,EAAE,SAAS,kCAAA,CAAmC;AAAA,EACzD,SAAS,OAAO;AACd,YAAQ,MAAM,6CAA6C,KAAK;AAChE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yCAAyC;AAAA,EACzE;AACF;ACtEA,MAAM,MAAM,KAAK,QAAQ,IAAI,oBAAqB;AAElD,eAAsB,yBAAyB;AAC7C,MAAI;AACF,UAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AASN,YAAQ,IAAI,gDAAgD;AAAA,EAC9D,SAAS,OAAO;AACd,YAAQ,MAAM,iEAAiE,KAAK;AAAA,EACtF;AACF;AAEA,eAAsB,gBAAgB,KAAc,KAAe;AACjE,MAAI;AACF,UAAM,gBAAgB,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAO5B,QAAI,KAAK,cAAc,SAAS,IAAI,cAAc,CAAC,IAAI,IAAI;AAAA,EAC7D,SAAS,OAAO;AACd,YAAQ,MAAM,mDAAmD,KAAK;AACtE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,4CAA4C;AAAA,EAC5E;AACF;AAEA,eAAsB,mBAAmB,KAAc,KAAe;AACpE,QAAM,EAAE,SAAS,UAAA,IAAc,IAAI;AAEnC,MAAI;AACF,UAAM;AAAA;AAAA;AAIN,QAAI,WAAW,QAAQ,QAAQ;AAC7B,YAAM,SAAS,MAAM;AAAA;AAAA,kBAET,QAAQ,KAAA,CAAM,KAAK,aAAa,KAAK;AAAA;AAAA;AAGjD,UAAI,KAAK,OAAO,CAAC,CAAC;AAAA,IACpB,OAAO;AACL,UAAI,KAAK,IAAI;AAAA,IACf;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,MAAM,kDAAkD,KAAK;AACrE,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gDAAgD;AAAA,EAChF;AACF;AClCO,SAAS,eAAe;AAC7B,QAAME,OAAMC,iBAAA;AAGZ,EAAAD,KAAI,IAAI,MAAM;AACd,EAAAA,KAAI,IAAIC,iBAAQ,MAAM;AACtB,EAAAD,KAAI,IAAIC,iBAAQ,WAAW,EAAE,UAAU,KAAA,CAAM,CAAC;AAG9C,iBAAA;AACA,mBAAA;AACA,yBAAA;AAGA,EAAAD,KAAI,IAAI,aAAa,CAAC,MAAM,QAAQ;AAClC,UAAM,OAAO,QAAQ,IAAI,gBAAgB;AACzC,QAAI,KAAK,EAAE,SAAS,KAAA,CAAM;AAAA,EAC5B,CAAC;AAED,EAAAA,KAAI,IAAI,aAAa,UAAU;AAG/B,EAAAA,KAAI,KAAK,mBAAmB,KAAK;AACjC,EAAAA,KAAI,IAAI,gBAAgB,WAAW,cAAc;AAGjD,EAAAA,KAAI,IAAI,cAAc,WAAW,sBAAsB,MAAM,GAAG,WAAW;AAC3E,EAAAA,KAAI,IAAI,kBAAkB,WAAW,sBAAsB,MAAM,GAAG,WAAW;AAC/E,EAAAA,KAAI,KAAK,cAAc,WAAW,sBAAsB,QAAQ,GAAG,UAAU;AAC7E,EAAAA,KAAI,IAAI,kBAAkB,WAAW,sBAAsB,QAAQ,GAAG,UAAU;AAChF,EAAAA,KAAI,OAAO,kBAAkB,WAAW,sBAAsB,QAAQ,GAAG,UAAU;AAGnF,EAAAA,KAAI,IAAI,iBAAiB,cAAc;AACvC,EAAAA,KAAI,IAAI,4BAA4B,aAAa;AACjD,EAAAA,KAAI,IAAI,qBAAqB,cAAc;AAC3C,EAAAA,KAAI,KAAK,iBAAiB,WAAW,yBAAyB,QAAQ,GAAG,aAAa;AACtF,EAAAA,KAAI,IAAI,qBAAqB,WAAW,yBAAyB,QAAQ,GAAG,aAAa;AACzF,EAAAA,KAAI,OAAO,qBAAqB,WAAW,yBAAyB,QAAQ,GAAG,aAAa;AAG5F,EAAAA,KAAI,KAAK,eAAe,WAAW;AACnC,EAAAA,KAAI,IAAI,eAAe,WAAW,YAAY;AAC9C,EAAAA,KAAI,IAAI,mBAAmB,WAAW,YAAY;AAClD,EAAAA,KAAI,IAAI,0BAA0B,WAAW,uBAAuB,UAAU,GAAG,iBAAiB;AAClG,EAAAA,KAAI,OAAO,mBAAmB,WAAW,uBAAuB,QAAQ,GAAG,WAAW;AAGtF,EAAAA,KAAI,IAAI,8BAA8B,WAAW,4BAA4B,eAAe,GAAG,eAAe;AAC9G,EAAAA,KAAI,KAAK,0BAA0B,WAAW,4BAA4B,eAAe,GAAG,KAAK;AACjG,EAAAA,KAAI,OAAO,0BAA0B,WAAW,4BAA4B,eAAe,GAAG,OAAO;AAGrG,EAAAA,KAAI,IAAI,sBAAsB,eAAe;AAC7C,EAAAA,KAAI,IAAI,sBAAsB,WAAW,sBAAsB,MAAM,GAAG,kBAAkB;AAE1F,SAAOA;AACT;AAEA,SAAS,4BAA4B,YAA6B;AAChE,SAAO,CAAC,KAAU,KAAU,SAAc;AACxC,QAAI,CAAC,IAAI,MAAM;AACb,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wDAAwD;AAAA,IAC/F;AAEA,UAAM,cAAc,IAAI,KAAK;AAE7B,QAAI,CAAC,aAAa;AAChB,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8DAA8D;AAAA,IACrG;AAEA,QAAI,CAAC,YAAY,cAAc,CAAC,YAAY,WAAW,UAAU,GAAG;AAClE,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK;AAAA,QAC1B,OAAO;AAAA,MAAA,CACR;AAAA,IACH;AAEA,SAAA;AAAA,EACF;AACF;ACrGA,MAAM,MAAM,aAAA;AACZ,MAAM,OAAO,QAAQ,IAAI,QAAQ;AAGjC,MAAME,cAAY,YAAY;AAC9B,MAAM,WAAW,KAAK,KAAKA,aAAW,QAAQ;AAG9C,IAAI,IAAI,QAAQ,OAAO,QAAQ,CAAC;AAGhC,IAAI,IAAI,CAAC,KAAK,KAAK,SAAS;AAE1B,MAAI,IAAI,KAAK,WAAW,OAAO,KAAK,IAAI,KAAK,WAAW,SAAS,GAAG;AAClE,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B;AAAA,EACjE;AAEA,MAAI,SAAS,KAAK,KAAK,UAAU,YAAY,CAAC;AAChD,CAAC;AAED,IAAI,OAAO,MAAM,MAAM;AACrB,UAAQ,IAAI,4CAA4C,IAAI,EAAE;AAC9D,UAAQ,IAAI,iCAAiC,IAAI,EAAE;AACnD,UAAQ,IAAI,4BAA4B,IAAI,MAAM;AACpD,CAAC;AAGD,QAAQ,GAAG,WAAW,MAAM;AAC1B,UAAQ,IAAI,+CAA+C;AAC3D,UAAQ,KAAK,CAAC;AAChB,CAAC;AAED,QAAQ,GAAG,UAAU,MAAM;AACzB,UAAQ,IAAI,8CAA8C;AAC1D,UAAQ,KAAK,CAAC;AAChB,CAAC;"}